{"pageProps":{"CategoricalPostData":[{"contentHtml":"<p>※諸注意</p>\n<blockquote>\n<p>cf. @solafune(<a href=\"https://solafune.com\">https://solafune.com</a>) コンテストの参加以外を目的とした利用及び商用利用は禁止されています。商用利用・その他当コンテスト以外で利用したい場合はお問い合わせください。(<a href=\"https://solafune.com\">https://solafune.com</a>)</p>\n</blockquote>\n<p><a href=\"https://solafune.com/\">Solafune</a>というプラットフォームでのMScupで低解像度を超解像化する珍しいコンペが出てきて，楽しそうだと（実際楽しかったけど）2ヶ月従事したものの11位で終わってしまいました😭</p>\n<p>でも，学べることがたくさんあったし，画像系コンペに出てこなかったので，画像系でも活かせそうな知見が得られて楽しいコンペでした．</p>\n<p>実験してみて効いたこと効かなかったことや学んだことをまとめます．</p>\n<h2>結果報告</h2>\n<p>先に結果を報告してしまいます．</p>\n<p>タイトルですでに出オチですが，<strong>11位フィニッシュ</strong>でした🎉</p>\n<p>PublicもPrivateも共に11位だったので，Trust CV，Trust LBなコンペだったと思います．そのためとても取り組みやすかったです．</p>\n<p>また，ライセンス表記に対してシビアではありましたが，運営さんの方から使っていいライセンスが詳しく話されていたので，これに関しても取り組みやすかったと思っています．</p>\n<p>結果で見れば悔しい結果ですが，総評してとても楽しかったです🤗</p>\n<h2>コンペ概要</h2>\n<p>概要は以下です．</p>\n<blockquote>\n<p>衛星画像を活用する際の課題の一つに「解像度」の問題があります。人工衛星は広域を撮影できる一方で、解像度の低さがボトルネックになります。近年、解像度が高い衛星画像の提供・販売が始まっていますが、利用可能な高解像データは世界で最も解像度が高い画像でも30cm程度です。また、高解像度のデータは値段が高く、利用規約にも様々な制限が課せられています。さらに、現時点では高解像度の画像データは法律で利用を禁止している国もあります。 そのため、今回のコンテストでは高解像度のデータを安く利用するための手段として、超解像を扱います。将来的に高解像度の衛星画像を扱えるようになることを想定して、本コンテストでは25 cm解像度の画像データを扱います。「超解像」という技術を通して、衛星データや航空写真などの地理空間データの社会実装が加速することを期待しています。</p>\n</blockquote>\n<p>与えられて低解像度の画像に対して，高解像化をかけるモデル，アルゴリズムを作成し，SSIMが高くすることが課題でした．</p>\n<p>SSIMは以下で表され，これを最大化することを目的とします．</p>\n<p>$$\nSSIM(x, y) = \\frac{(2\\mu_x\\mu_y + c_1)(2\\sigma_{xy} + c_2)}{(\\mu_x^2 + \\mu_y^2 + c_1)(\\sigma_x^2 + \\sigma_y^2 + c_2)}\n$$</p>\n<h2>My Solution</h2>\n<p>僕のSolutionは大したことができませんでした．というのも，たくさんの実験を試したのですが，ほとんどうまくいかず悪化し，結局Seed Averagingなどの手抜きアイデアが最終サブになってしまったからです．</p>\n<p>とは言いつつも，おそらく僕独自の手法も入っているのではないかと思うので参考になればと思います．</p>\n<h3>モデル概要</h3>\n<p>訓練時は以下のようなモデル設計になっています．</p>\n<p><img src=\"/images/article/mscup/mscup_train.jpg\" alt=\"訓練時モデル\"></p>\n<p>推論時は<strong>Seed Averaging</strong>と**TTA（Test Time Augmentation）**を利用して，テストデータでの推論時にロバストに推論ができるようにしました．Seed Averagingは5つくらいのモデルの平均をとったはずです．</p>\n<p>Seed AveragingやTTAは正直つまらない解法だと思っていますが，<strong>Sobel Filterを利用したLoss関数</strong>や<strong>CutMixやCutout</strong>などのData Augmentationが個人的な解法のウリではあります．</p>\n<p>また，僕がコンペを進める中での一番力を入れたことは，<strong>Loss関数による精度向上</strong>です．モデルも比較しましたが，結局SOTAモデルのSwinIRが圧巻で，Augmentationも思ったほど効かなかったので，Loss関数で制御することが最もの試みでした．これは独自の取り組みだと思っています（思いたい）</p>\n<p><a href=\"#%E5%AE%9F%E9%A8%93%E4%B8%AD%E3%81%AE%E8%AA%B2%E9%A1%8C%E6%84%9F%E3%81%A8%E5%B7%A5%E5%A4%AB\">次のセクション</a>で，なぜその実装をしたかと結果を話したいと思います．</p>\n<h3>実験中の課題感と対処法</h3>\n<p>実験している中での課題をまずは簡単に．</p>\n<ol>\n<li><a href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%81%8C%E5%B0%91%E3%81%AA%E3%81%84\">データセットが少ない</a>\n<ul>\n<li>画像が大きいので，クロップすればデータはたくさんあるのですが，多様性という面では多いとは言えなかったかもしれない．</li>\n</ul>\n</li>\n<li><strong>回転のAugmentationを加えるとノイズになる</strong>\n<ul>\n<li>エッジの再現性が重要となる超解像タスクでは，回転後のギザギザがノイズになってしまう．</li>\n<li>初めて知ったけど， 超解像タスクでは90度単位での回転が基本動作．画像見比べてなるほどってなった．</li>\n</ul>\n</li>\n<li><strong>超解像時にエイリアシングが起きたとき，エッジの向きに再現性がない</strong>\n<ul>\n<li>データを見ていてこれが問題と感じて，Sobel Filterを施そうと...</li>\n<li>細くは改めて話します．</li>\n</ul>\n</li>\n<li>Augmentationなんでもいいと思いきや，CutBlurやMixupはノイズだった\n<ul>\n<li>実装の苦労の割に大幅悪化で辛かった...</li>\n</ul>\n</li>\n</ol>\n<p>それでは上記について，細かく述べていこうと思います．</p>\n<h4>データセットが少ない</h4>\n<p>訓練データは60シーンあり，クロップすればデータは多く感じるものの，やはり多様性という時点では少ないなぁという印象でした．</p>\n<p>上位者の公開Solutionでは外部データの利用が鍵になったという指摘もあり，ここの調べを怠ったのが大敗につながってしまったのかなとも思っています．</p>\n<p>そうは言っても全く対処しなかったわけではなく，「<a href=\"https://arxiv.org/abs/2004.00448\">Rethinking Data Augmentation for Image Super-resolution: A Comprehensive Analysis and a New Strategy</a>」で提案されたData Augmentationの手法をPytorchパイプラインに合うように再実装し，実験はしました．</p>\n<p>効き目は以下のような感じでした．</p>\n<table>\n<thead>\n<tr>\n<th>手法</th>\n<th>説明</th>\n<th>効き目</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CutBlur</td>\n<td>低解像度に高解像度の画像を部分的に差し込む（またはその逆）</td>\n<td>×</td>\n</tr>\n<tr>\n<td>Cutout</td>\n<td>一定確率でピクセル値を0にする</td>\n<td>△</td>\n</tr>\n<tr>\n<td>CutMix</td>\n<td>異なる画像を部分的に差し込む</td>\n<td>○</td>\n</tr>\n<tr>\n<td>Mixup</td>\n<td>beta分布に従って異なる画像を混合する</td>\n<td>×</td>\n</tr>\n<tr>\n<td>CutMixup</td>\n<td>CutMixとCutupを同時に行う</td>\n<td>×</td>\n</tr>\n<tr>\n<td>Blend</td>\n<td>一様分布に従ってサンプリングされた色を混合する</td>\n<td>△</td>\n</tr>\n<tr>\n<td>RGBPermutation</td>\n<td>RGBの順番を変える</td>\n<td>△</td>\n</tr>\n</tbody>\n</table>\n<p>実際に効いているかはそこまで詳しく見ることはできていませんが，スコアや生成された高解像度画像を見ているとこんな感じだったと思います．</p>\n<p>効き目の詳細は改めて話します．</p>\n<h4>回転のAugmentationを加えるとノイズになる</h4>\n<p>これは最初気づかなくて，エッジがめちゃくちゃ鈍った画像が生成されたので分析した結果わかったことです．</p>\n<p>画像ドメインを持っている人ならば当たり前に感じてしまうかもしれませんが，画像にドメインのない人にとっては最後まで気づかなくてもおかしくなかったと思っています．</p>\n<p>ライブラリの仕様でも，回転を加える関数には，<em>interpolation</em>などのデータ補間のための引数があるはずです．</p>\n<p>例えば<em>torchvision</em>ですが，ランダムでの回転は以下で実装されます．</p>\n<pre><code><span>import</span> torchvision.transforms <span>as</span> T\n\n<span># ニアレストネイバーでの補間</span>\ntransforms = T.RandomRotation(degrees=<span>180</span>, interpolation=T.InterpolationMode.NEAREST)\n<span># バイリニアでの補間</span>\ntransforms = T.RandomRotation(degrees=<span>180</span>, interpolation=T.InterpolationMode.BILINEAR)</code></pre>\n<p>この実装を見る限りでも，エッジの部分が補間されることで元の入力画像との再現が取れなくなってしまうことは想像できると思います．</p>\n<p>これは学びでしたが，超解像タスクにおいては，<strong>回転のAugmentationは90度単位</strong>というのが主流のようでした．</p>\n<h4>超解像時にエイリアシングが起きたとき，エッジの向きに再現性がない</h4>\n<p>本当は画像を見せた方が早いのですが，今回のコンペで使用された画像は公開できないので，手書きで頑張って表現しようと思います．</p>\n<p>田んぼみたいに，ある程度イネを植えている方向に規則的な向きがあるような感覚を想像してください．</p>\n<p>実験中下のような画像が生成されてしまいました．</p>\n<p><img src=\"/images/article/mscup/edge.png\" alt=\"エッジが再現できない生成画像\"></p>\n<p>SSIMを最適化するのですが，<a href=\"https://kornia.readthedocs.io/en/latest/index.html\">kornia</a>で実装されていた<em>SSIM Loss</em>では，入力画像をGaussian Filterで平滑化してからSSIMの計算をかけていたので，ぼやけた状態でうまくreconstructできるかを学習してしまっていたのだと思います．</p>\n<p>そこで僕は追加で<em>Smooth L1 Loss</em>をさらに追加しました．こちらはピクセルごとでロスが計算されるので細かいところまで再現できるかなと思ったのですが，MSEなどのピクセルを見るLoss関数は画像全体がぼやけてしまうらしいです．</p>\n<p>結果行き着いた発想が，「<strong>エッジに対してLossを計算してしまえばいいじゃない？？</strong>」でした．</p>\n<p>これは結果的にスコア微増に起因したのですが，前に示した図のようなエイリアシングが取れていることが多く，実装と結果が直感的だったので最後まで採用しました．数学的に正しい感じは全くありませんが，なんかうまくいったので（正しいかは知りません．こいつほんまに微分可能なんか？ってお気持ちのままやってました笑）</p>\n<p>実装上は，Sobel Filterをかけて，エッジ抽出された画像に対してSmooth L1 Lossを計算するように計算しました．</p>\n<p>当時の実装を下記に載っけておきます．</p>\n<pre><code><span><span>class</span> <span>MeanSobelError</span>(<span>nn.Module</span>):</span>\n   <span>\"\"\"\n   Sobel Gradient Loss Function\n   \"\"\"</span>\n   <span><span>def</span> <span>__init__</span>(<span>self,\n      normalized: <span>bool</span> = <span>True</span>,\n      eps: <span>float</span> = <span>1e-6</span>,\n      reduction: <span>str</span> = <span>'mean'</span>,\n   </span>):</span>\n      <span>super</span>(MeanSobelError, self).__init__()\n      self.<span>filter</span> = kornia.filters.Sobel(\n         normalized=normalized,\n         eps=eps,\n      )\n      self.lossfn = nn.SmoothL1Loss(reduction=reduction)\n\n   <span><span>def</span> <span>forward</span>(<span>self,\n      y_pred: torch.Tensor,\n      y_true: torch.Tensor,\n   </span>):</span>\n      filtered_pred = self.<span>filter</span>(y_pred)\n      filtered_true = self.<span>filter</span>(y_true)\n\n      loss = self.lossfn(filtered_pred, filtered_true)\n      <span>return</span> loss</code></pre>\n<h4>Augmentationなんでもいいと思いきや，CutBlurやMixupはノイズだった</h4>\n<p>SISRタスクにおいて提案されていたAugmentationは全部効くだろう！というスタンスで，<strong>コンペ終盤に時間をめちゃくちゃかけて実装</strong>し，全部ごちゃ混ぜでやってみたのですが，スコアが激減....</p>\n<p>幾つかパターンを試しましたが，CutBlurやMixup系はスコアの悪化の原因だったっぽいです．</p>\n<ul>\n<li>Mixup\n<ul>\n<li>画像を割合で混合するので，エッジが鈍りがちになってしまいました．</li>\n<li>車や車線など，エッジがはっきりした画像生成が必要だったため，ノイズになってしまったのかもしれません．</li>\n</ul>\n</li>\n<li>CutBlur\n<ul>\n<li>こちらは単純にモデル作成が下手くそなのかも知れないです．</li>\n<li>SwinIRに入力する前に，ダウンサンプリング層を用意する必要がありました．</li>\n<li>↑これがうまく学習できず，生成される画像の色がおかしかったです．\n<ul>\n<li>一応ダウンサンプリング層のみのwarmupなども試したが，うまく適合できず，この実装はボツに...（めっちゃ時間かけたのに...）</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>こんな感じで効くAugmentationと効かないAugmentationがあったので，早い段階でこの実装と実験ができていれば，もっと豊かな実験ができたかなと反省しています．</p>\n<p>Augmentationはいずれコンペ中は確実に試すことになると思うので，早めに効くかどうか先にやっておくといいのかも（？）</p>\n<h2>まとめ</h2>\n<p>最後に今回のコンペで得た知見をまとめたいと思います．</p>\n<ul>\n<li>Augmentationはタスク依存．課題感を意識したり，早めに取り組んだ方がいいかも（？）</li>\n<li>データセットのやりくりはサボらない\n<ul>\n<li>外部データの調査とかEDAとか</li>\n</ul>\n</li>\n<li>スコアだけでなく，予測値も確認してみる\n<ul>\n<li>今回はラベル分布とかそういうのではないので，生成画像もしっかり確認するなど</li>\n<li>それを割としっかりやったのでSobel Filterに行き着いたと思っています．</li>\n</ul>\n</li>\n<li>論文とにかく読んでアイデアを得よう\n<ul>\n<li>めっちゃ読んで，実装して効かなかったアイデアが8割くらいだったけど，楽しかったです．</li>\n<li>今，大学で取り組んでいるNLPの研究にアイデアが入ったりしているので，やり切るって大事！</li>\n</ul>\n</li>\n<li><strong>楽しむ！！！</strong>\n<ul>\n<li>コンペは序盤と終盤がとても辛いです．\n<ul>\n<li>序盤：バグが取れない．公開のやつに勝てない．</li>\n<li>終盤：スコアが伸び悩む．</li>\n</ul>\n</li>\n<li>でも，やり切れば結果楽しい（MScupが楽しかった説に一票ですが😂）</li>\n<li>CVやLBをおかずに飯が食えるぞ？</li>\n</ul>\n</li>\n</ul>\n<p>僕が今回のMScupを通して学んだことはこんなところでしょうか．次もしSolafuneのコンペに参加することがあれば，しっかり賞金圏に入りたいと思います！</p>\n<p>最後に今回のコンペで使ったライブラリや実装したコードを載せて終わりにしたいと思います．</p>\n<p>つらつらと思うところを書きましたが，最後まで読んでいただきありがとうございます．意見やご指摘などがありましたら，Twitterなどでご連絡ください．</p>\n<h2>よく使ったライブラリなど</h2>\n<p>今回のコンペでよく使えたライブラリなどを載っけておきます．</p>\n<ul>\n<li><a href=\"https://kornia.readthedocs.io/en/latest/index.html\">kornia</a>\n<ul>\n<li>ssim lossやsobel filterなど，画像処理で手前実装が大変でかゆいところに手が届きました．今後も自分は使うことがありそうだと感じました．</li>\n</ul>\n</li>\n<li><a href=\"https://github.com/JingyunLiang/SwinIR\">SwinIR</a>\n<ul>\n<li>SISRにおけるSOTAモデル．事前学習済みモデルが公開されており，重宝しました．一番強かった...</li>\n<li><a href=\"https://arxiv.org/abs/2108.10257\">paper</a></li>\n</ul>\n</li>\n<li><a href=\"https://huggingface.co/models?other=image-super-resolution\">image-super-resolution</a>\n<ul>\n<li>さまざまなSuper Resolutionタスクでのモデルの再現実装をされています．</li>\n<li>今回のコンペでは精度が微妙だったのでサブには使いませんでしたが，SISRタスクで遊びたい時に簡単に扱えると思います．</li>\n</ul>\n</li>\n<li>Pytorch Lightning\n<ul>\n<li>単純にファン．もう楽</li>\n</ul>\n</li>\n<li>Pytorch</li>\n<li>cv2\n<ul>\n<li>RGBの順番気をつけましょう．これで2週間くらい無駄にしました笑笑</li>\n</ul>\n</li>\n</ul>\n<h2>実装したコード</h2>\n<p><a href=\"https://github.com/yuta0306/SRAugmentation\">SRAugmentation</a>にて公開しています．</p>\n<p>初めてGitHubでスターをもらって喜んでいました（小並感</p>\n<p>CutBlurなど，Single Image Super ResolutionにおけるData Augmentationの手法を改めてPytorchのパイプラインに組み込めるように再実装したものです．</p>\n<p>こちらの論文で提案されています．<a href=\"https://arxiv.org/abs/2004.00448\">Rethinking Data Augmentation for Image Super-resolution: A Comprehensive Analysis and a New Strategy</a></p>\n","Title":"🛰MScupで11位だったけど，やったことまとめまくる","Date":"2022-02-13","Category":"Python","Tags":["データ分析","超解像","SISR","Super-Resolution","Pytorch"],"Authors":"ゆうぼう","Slug":"mscup-feedback","Thumbnail":"/images/thumbnails/mscup.jpg","Description":"MScupで低解像度を超解像化する珍しいコンペが出てきて，2ヶ月従事したけど11位で終わってしまいました．でも，学べることがたくさんあったし，画像系コンペに出てこなかったので，画像系でも活かせそうな知見が得られて楽しいコンペでした．実験してみて効いたこと効かなかったことや学んだことをまとめます．","Published":true},{"contentHtml":"<p>Transformersを使って入力テキストをtokenizeするときに，データセットのサイズが大きかったので，バッチ単位でエンコードしたかった時がありました．</p>\n<p>この時，collate_fnに対して複数の引数を与えたかった状況の時の対処法です．(日本語変か?)</p>\n<h2>やりたかったこと</h2>\n<p>DataLoaderを定義するときに，<code>collate_fn</code>のところで自作collate_fnを指定して，batch単位で流れてくるデータに対してエンコードすること．</p>\n<p>これがやりたいことになります．つまりこんな感じ</p>\n<pre><code><span>from</span> torch.utils <span>import</span> Dataset, DataLoader\n\n<span><span>class</span> <span>MyDataset</span>(<span>Dataset</span>):</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, *args, **kwargs</span>):</span>\n        <span>super</span>().__init__()\n        ...\n    \n    <span><span>def</span> <span>__len__</span>(<span>self</span>):</span>\n        ...\n\n    <span><span>def</span> <span>__getitem__</span>(<span>self, idx: <span>int</span></span>):</span>\n        ...\n\ndataloader = DataLoader(dataset=MyDataset(), batch_size=<span>16</span>, shuffle=<span>True</span>,\n            num_workers=os.cpu_count(),\n            collate_fn=custom_collate_fn)  <span># &#x3C;--- ここで自作collate_fnを指定して制御</span></code></pre>\n<h2>やってうまくいかなかったこと</h2>\n<p>先にやってうまくいかなかったことを共有しておきます．</p>\n<p>自分が使っているのが，<code>pytorch-lightning</code>なのでそのせいもあるかもしれません．なので，もしかしたら普通に素のPytorchならうまくいくかもしれません．</p>\n<p>教えてください🙏</p>\n<h3>lambda式で制御する (functools.partialを使う)</h3>\n<p>こんなことをしました．</p>\n<pre><code><span>from</span> torch.utils <span>import</span> Dataset, DataLoader\n<span>from</span> transformers <span>import</span> AutoTokenizer\n\n<span><span>class</span> <span>MyDataset</span>(<span>Dataset</span>):</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, *args, **kwargs</span>):</span>\n        <span>super</span>().__init__()\n        ...\n    \n    <span><span>def</span> <span>__len__</span>(<span>self</span>):</span>\n        ...\n\n    <span><span>def</span> <span>__getitem__</span>(<span>self, idx: <span>int</span></span>):</span>\n        ...\n        <span>return</span> text, label\n\n<span><span>def</span> <span>custom_collate_fn</span>(<span>data, tokenizer, max_length</span>):</span>\n    texts, labels = <span>zip</span>(*data)\n    texts = <span>list</span>(texts)\n    texts = tokenizer.batch_encode_plus(\n        texts,\n        padding=<span>True</span>,\n        truncation=<span>True</span>,\n        max_length=max_length,\n        return_tensors=<span>'pt'</span>,\n    )\n    labels = torch.LongTensor(labels)\n    <span>return</span> texts, labels\n\ntokenizer = AutoTokenizer.from_pretrained(...)\nmax_length = <span>256</span>\ndataloader = DataLoader(dataset=MyDataset(), batch_size=<span>16</span>, shuffle=<span>True</span>,\n            num_workers=os.cpu_count(),\n            collate_fn=<span>lambda</span> data: custom_collate_fn(data, tokenizer, max_length))</code></pre>\n<p><code>pytorch-lightning</code>の仕様だとは思うのですが，<code>pickle</code>で圧縮するらしくそのタイミングでエラーを吐かれました．</p>\n<p>なぜだろう...有識者の方教えてください...</p>\n<h2>【解決策】 classで定義する</h2>\n<p>lambda式でダメだったので，もうクラスの内部に必要なものを保持させておこうということになりました．(僕の中では)</p>\n<p>次のコードのような感じで解決しました．</p>\n<pre><code><span>from</span> torch.utils <span>import</span> Dataset, DataLoader\n<span>from</span> transformers <span>import</span> AutoTokenizer\n\n<span><span>class</span> <span>MyDataset</span>(<span>Dataset</span>):</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, *args, **kwargs</span>):</span>\n        <span>super</span>().__init__()\n        ...\n    \n    <span><span>def</span> <span>__len__</span>(<span>self</span>):</span>\n        ...\n\n    <span><span>def</span> <span>__getitem__</span>(<span>self, idx: <span>int</span></span>):</span>\n        ...\n        <span>return</span> text, label\n\n<span><span>class</span> <span>CollateFn</span>:</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, tokenizer, max_length: <span>int</span></span>) -> <span>None</span>:</span>\n        self.tokenizer = tokenizer\n        self.max_length = max_length\n        os.environ[<span>\"TOKENIZERS_PARALLELISM\"</span>] = <span>\"true\"</span>  <span># &#x3C;--- 多分これを明示的に指定しないと怒られます (true|false)</span>\n\n    <span><span>def</span> <span>__call__</span>(<span>self, data</span>):</span>\n        texts, labels = <span>zip</span>(*data)\n        texts = <span>list</span>(texts)\n        texts = self.tokenizer.batch_encode_plus(\n            texts,\n            padding=<span>True</span>,\n            truncation=<span>True</span>,\n            max_length=self.max_length,\n            return_tensors=<span>'pt'</span>,\n        )\n        labels = torch.LongTensor(labels)\n        <span>return</span> texts, labels\n\ntokenizer = AutoTokenizer.from_pretrained(...)\nmax_length = <span>256</span>\ndataloader = DataLoader(dataset=MyDataset(), batch_size=<span>16</span>, shuffle=<span>True</span>,\n            num_workers=os.cpu_count(),\n            collate_fn=CollateFn(tokenizer, max_length))</code></pre>\n<h2>まとめ</h2>\n<p>素のPytorchで組めば問題なかったのかもしれませんが，<code>pytorch-lightning</code>を使っている方は同じ状況になるかもしれません．</p>\n<p>その時は，ぜひ参考にclassでcollate_fnで実装してみて解決の一助となれたら幸いです．</p>\n","Title":"collate_fnで複数の引数を取りたい!!","Date":"2021-12-24","Category":"Python","Tags":["ML","Python","Pytorch"],"Authors":"ゆうぼう","Slug":"pytorch-collate_fn-args","Thumbnail":"/images/thumbnails/pytorch-logo.jpg","Description":"Transformersを使って入力テキストをtokenizeするときに，データセットのサイズが大きかったので，バッチ単位でエンコードしたかった時がありました．この時，collate_fnに対して複数の引数を与えたかった状況の時の対処法です．(日本語変かも)","Published":true},{"contentHtml":"<p>Colab Proでなんとかpytorch-lightningを使ってTPUで実験を回そうと奮闘した結果，得られたベストプラクティス?(怪しい)の共有です．</p>\n<p>もっといい方法があったら教えてください．</p>\n<p>ちなみに，現行コンペで動作確認したので，コード全容の公開はないです．すみません．</p>\n<p><strong>Runtimeは必ずTPUにしてください</strong></p>\n<h2>pytorch-lightningでTPUを使いたいメリット?</h2>\n<p>黙って<em>tensorflow</em>を勉強して書けば，それでいいのでしょうが，<br>\n普段<em>pytorch</em>を使ってコーディングをしていて，僕の場合<em>pytorch-lightning</em>を好んで使っているので，その延長戦でTPUを使いたいという欲がありました．</p>\n<p>また，<em>pytorch-lightning</em>は，<strong>Trainerクラス</strong>をちょろっと書き換えるだけで，CPU/GPU/TPUの変換ができ，マルチGPU等のDDPの処理も自動で書き加えてくれるため，<br>\nかなり良いものかなと思っています．</p>\n<p>CPU/GPU/TPUの書き換えは基本的に以下で十分です．</p>\n<pre><code><span>import</span> pytorch_lightning <span>as</span> pl\n<span># これらは共通</span>\nmodel = LitModel()  <span># pl.LightningModuleを継承した何か</span>\ndm = LitDataset()  <span># pl.LightningDataModuleを継承した何か</span>\n\n<span># CPUを使う</span>\ntrainer = Trainer()\ntrainer.fit(model, dm)\n\n<span># GPUを使う</span>\ntrainer = Trainer(gpus=-<span>1</span>)  <span># ありったけのGPU使う</span>\ntrainer.fit(model, dm)\n\n<span># Single Core TPUを使う</span>\ntrainer = Trainer(tpu_cores=[<span>5</span>])  <span># TPUのインデックス指定</span>\ntrainer.fit(model, dm)\n\n<span># Multi Core TPUを使う</span>\ntrainer = Trainer(tpu_cores=<span>8</span>)  <span># 1 or 8じゃないと怒られます...</span>\ntrainer.fit(model, dm)</code></pre>\n<p>ああ，楽だ楽だ．</p>\n<p>TPU簡単に動いてくれたらいいのに(願望)</p>\n<h2>TPUを使うためのセットアップ</h2>\n<p>以下を実行して，必要なライブラリ群を入れてしまいます．</p>\n<p>一応僕が動作確認取れたのは，pytorch-xlaのバージョンが<em>1.8</em>と<em>1.9</em>です．</p>\n<p>Circle CIのTPU環境に合わせたユニットテストは，確か1.8が通っていて，1.9がエラーを吐いていた気がします．</p>\n<p>1.8の方が安全なのですかね？(わかりません)</p>\n<p><em>pytorch-xla 1.8</em></p>\n<pre><code>!pip install cloud-tpu-client==<span>0.10</span> https://storage.googleapis.com/tpu-pytorch/wheels/torch_xla-<span>1.8</span>-cp37-cp37m-linux_x86_64.whl\n!pip install -q torch==<span>1.8</span> torchvision torchtext\n!pip install -q pytorch-lightning==<span>1.4</span><span>.9</span> torchmetrics</code></pre>\n<p><em>pytorch-xla 1.9</em></p>\n<pre><code>!pip install cloud-tpu-client==<span>0.10</span> https://storage.googleapis.com/tpu-pytorch/wheels/torch_xla-<span>1.9</span>-cp37-cp37m-linux_x86_64.whl\n!pip install -q torch==<span>1.9</span> torchvision torchtext\n!pip install -q pytorch-lightning==<span>1.4</span><span>.9</span> torchmetrics</code></pre>\n<p>pipでのインストール分割していたり，--quit(-q)をつけているのは特に理由はないです．</p>\n<p>その辺はお好みでやってください．</p>\n<p>一応僕の環境ではこんな感じで，以後のプログラムはうまいこと動作しました．</p>\n<p>おそらく以下のようなエラーは起きますが，特に動作に影響はなさそうでした．あまり不安がらなくても良さそうです．</p>\n<pre><code>ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.\nearthengine-api 0.1.284 requires google-api-python-client&#x3C;2,>=1.12.1, but you have google-api-python-client 1.8.0 which is incompatible.</code></pre>\n<h2>セットアップ後にimport pytorch_lightning</h2>\n<pre><code><span>import</span> pytorch_lightning <span>as</span> pl</code></pre>\n<p><em>import</em>すると以下のような出力を吐きます．</p>\n<p>インストールした<em>xla</em>のバージョンが1.9ならば，以下のようなメッセージが出ます．</p>\n<p>少し時間がかかりますが，待ちましょう．</p>\n<p><em>pytorch-xla 1.9</em></p>\n<pre><code>WARNING:root:Waiting for TPU to be start up with version pytorch-1.9...\nWARNING:root:Waiting for TPU to be start up with version pytorch-1.9...\nWARNING:root:Waiting for TPU to be start up with version pytorch-1.9...\nWARNING:root:TPU has started up successfully with version pytorch-1.9</code></pre>\n<p>もし，<em>TPU not Found</em>的なことが出たら，一回<em>Factory reset Runtime</em>して，またインストールからやり直せばうまく行くと思います．</p>\n<h2>importまでうまく行けたら</h2>\n<p><em>import</em>するまで行けたら，このあとは特に問題なく動くはずです．</p>\n<pre><code><span># ModelとかDataModuleとかは適宜設定してください．</span>\n\ntrainer = Trainer(tpu_cores=<span>8</span>)\ntrainer.fit(model, dm)</code></pre>\n<p>このあとすぐエラー出なきゃ，勝手に動くと思います(雑ww)</p>\n<h2>注意するべきこと</h2>\n<p>幾つか僕が遭遇したエラーを挙げておきます．</p>\n<ul>\n<li>wandb loggerが使えない\n<ul>\n<li>多分Commet loggerも使えない？</li>\n</ul>\n</li>\n<li>マルチコアTPU使うなら，predict時return_predictionsができない\n<ul>\n<li><em>pytorch_lightning.callbacks.BasePredictionWriter</em>を使おう(<a href=\"#BasePredictionWriter%E3%81%AE%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB\">サンプル</a>)</li>\n</ul>\n</li>\n<li>なぜか知らんけど，<a href=\"#RAM%E3%81%AE%E4%BD%BF%E7%94%A8%E7%8E%8750%25%E3%81%8F%E3%82%89%E3%81%84%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%A8stack%E3%81%99%E3%82%8B%E4%BB%B6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"><strong>RAMの使用率が50%あたりになるとstackする</strong></a>\n<ul>\n<li>こうなると一生動かなくなるので，<strong>最初安定するまで監視が必要</strong></li>\n<li>Colabの下のデバッガみたいなやつが，ずっと*select() > spawn()*的な非同期のところで止まるので，そうなったらRAMチェックしよう!!!</li>\n</ul>\n</li>\n</ul>\n<h2>BasePredictionWriterのサンプル</h2>\n<pre><code><span>from</span> pytorch_lightning.callbacks <span>import</span> BasePredictionWriter\n\n<span><span>class</span> <span>CustomWriter</span>(<span>BasePredictionWriter</span>):</span>\n\n    <span><span>def</span> <span>__init__</span>(<span>self, output_dir: <span>str</span>, write_interval: <span>str</span> = <span>'batch'</span></span>):</span>\n        <span>super</span>().__init__(write_interval)\n        self.output_dir = output_dir\n\n    <span><span>def</span> <span>write_on_batch_end</span>(<span>\n        self, trainer, pl_module: <span>'LightningModule'</span>, prediction: <span>Any</span>, batch_indices: <span>List</span>[<span>int</span>], batch: <span>Any</span>,\n        batch_idx: <span>int</span>, dataloader_idx: <span>int</span>\n    </span>):</span>\n        torch.save(prediction, os.path.join(self.output_dir, dataloader_idx, <span>f\"<span>{batch_idx}</span>.pt\"</span>))\n\n    <span><span>def</span> <span>write_on_epoch_end</span>(<span>\n        self, trainer, pl_module: <span>'LightningModule'</span>, predictions: <span>List</span>[<span>Any</span>], batch_indices: <span>List</span>[<span>Any</span>]\n    </span>):</span>\n        torch.save(predictions, os.path.join(self.output_dir, <span>\"predictions.pt\"</span>))</code></pre>\n<h2>RAMの使用率50%くらいになるとstackする件について</h2>\n<p>はっきり言って，これは本当に原因がわかりません．</p>\n<p>50%くらいで張りついちゃうので，batch_size下げようが，RAMの使用率はあまり変わる気がしません．</p>\n<p>こうなってstackしちゃったら，もうHigh-RAM設定にしてRAMにゆとりを持たせた方がいいと思います．潔く．</p>\n<p>High-RAMでも張りついちゃう場合は，僕はわかりません．</p>\n<p>RAM周りの最適化とか知見ある方，解決策わかったら共有してくださるととてもありがたいです......</p>\n<h2>まとめ</h2>\n<p>まとめじゃないです．嘘つきました．</p>\n<p>でも，まとめないとなんかあれなので，CPU/GPU/TPUで使いまわせるように，セットアップの部分整理します．</p>\n<pre><code><span>import</span> os\n<span>import</span> sys\n\n<span>if</span> os.environ.get(<span>'COLAB_TPU_ADDR'</span>, <span>False</span>):\n    !pip install cloud-tpu-client==<span>0.10</span> https://storage.googleapis.com/tpu-pytorch/wheels/torch_xla-<span>1.8</span>-cp37-cp37m-linux_x86_64.whl\n    !pip install -q torch==<span>1.8</span> torchvision torchtext\n\n!pip install pytorch-lightning==<span>1.4</span><span>.9</span> torchmetrics</code></pre>\n<p>もし，KaggleとColabでも行けるようにしたいのであれば，<code>'google.colab' in sys.modules</code>でやるといいと思います．</p>\n<p>Colab TPU使って，pytorch-lightningでうまく実験回しまくっている方いたら，色々意見ください．お願いします :)</p>\n<p>知見たまって，エラーハンドリングとかわかってきたら，この記事更新するか，新たに書き始めます．よろしくお願いします．</p>\n","Title":"Pytorch LightningでTPUを回す on Colab Pro in 2021","Date":"2021-10-11","Category":"Python","Tags":["pytorch-lightning","Colab"],"Authors":"ゆうぼう","Slug":"pytorch-lightning_on_colab-tpu_2021","Thumbnail":"/images/thumbnails/pytorch-lightning_on_colab-pro-tpu.png","Description":"Colab Proでなんとかpytorch-lightningを使ってTPUで実験を回そうと奮闘した結果，得られたベストプラクティスの共有です．もっといい方法があったら教えてください．","Published":true},{"contentHtml":"<p>対話システムをサーバ上で動かせる体制を作るために，pytorchやら何やらをHerokuでinstallさせる必要があったのですが，**pytorchちょっとデカすぎませんか？**という状態でエラーが出てしまいました．その時の解消法です．</p>\n<h2>Pytorchデカすぎませんか？</h2>\n<p>Herokuはデプロイ時には，500MBに収まる必要があるのですが，<br>\nまさかのpytorchは<strong>831.4 MB</strong>.</p>\n<p>は？</p>\n<p><img src=\"/images/article/torch-weight.png\" alt=\"Pytorchの容量\"></p>\n<p>正直焦りました．</p>\n<p>躓くところ，そことは想定していなかったので（笑）</p>\n<p>なんとか500MBに収める方法次に紹介します．</p>\n<h2>【解消法】 CPUのみ対応版をinstallさせる</h2>\n<p>色々調べてみたところ，原因は，<strong>CPU/GPU両対応のため色々入って重い</strong>ことらしいです．</p>\n<p>そういうことなので，CPUのみに対応させることにしました．(HerokuもCPUしか動作させられないので...)</p>\n<p>requirements.txtを多少工夫します．</p>\n<h3>変更前のrequirements.txt</h3>\n<pre><code>...\ntorch==<span>1.9</span><span>.0</span>\n...</code></pre>\n<h3>変更後のrequirements.txt</h3>\n<p>インターネット上のファイルを参照させます．</p>\n<pre><code>-f https://download.pytorch.org/whl/torch_stable.html\ntorch==<span>1.9</span><span>.0</span>+cpu</code></pre>\n<p>こうすることで，どうしてもサイズがでかいままですが，元よりはかなり圧縮できました．</p>\n<p><img src=\"/images/article/torch-cpu-weight.png\" alt=\"Pytorch軽量後の容量\"></p>\n<p>831.4 → 175.5ダウンなので，かなり軽量化した感じがします．</p>\n<h2>やってみたけどダメだったこと</h2>\n<p>上記のCPUのみ対応版にする前にやってみたが，ダメだったことがあります．</p>\n<p>デプロイ後に，「<em>pip install torch</em>」を含むrun.shを走らせてインストールさせることです．</p>\n<p>うまくいくと思ったのですが，重すぎてOut of Memoryでした...</p>\n","Title":"Pytorch, Herokuにはデカすぎる問題","Date":"2021-09-30","Category":"Python","Tags":["Heroku"],"Authors":"ゆうぼう","Slug":"heroku-install-torch","Thumbnail":"/images/thumbnails/heroku-install-torch.png","Description":"対話システムをサーバ上で動かせる体制を作るために，pytorchやら何やらをHerokuでinstallさせる必要があったのですが，pytorchちょっとデカすぎませんか？という状態でエラーが出てしまいました．その時の解消法です．","Published":true},{"contentHtml":"<p><em>pip install tensorflow</em>でtensorflowをインストールしてディープラーニングをやろうとした矢先の事、パッケージが足りないだと...。その時の解決策がとても簡単だったのですが、この手の問題はtensorflowに限らず起こりそうなので、記録しておきます。</p>\n<h2>発生したエラー No such file or directory</h2>\n<p>今回はなぜかインストールに必要なパッケージのメタファイルがなくて、「No such file or directory」と怒られたわけです。</p>\n<p>そして、今回足りなかったパケージが<strong>google_pasta-0.2.0.dist-info/METADATA</strong>でした。</p>\n<p>実際のエラーが以下になります。</p>\n<pre><code>ERROR: Could not install packages due to an EnvironmentError:\n[Errno 2] No such file or directory:\n<span>'/Users/usr/opt/anaconda3/envs/myenv/lib/python3.7/site-packages/google_pasta-0.2.0.dist-info/METADATA'</span></code></pre>\n<h2>【解決策】もうtouchでファイル作っちゃえ!!</h2>\n<p>よくわからないエラーだし、本当になんでこうなったかの経緯が掴めないのですが、<br>\nファイルがないとかディレクトリがないとか言っているのでとりあえず<em>もうファイル作っちゃえ!!</em></p>\n<p>という事で<strong>touch</strong>でファイル作っちゃいます(笑)</p>\n<pre><code>$ touch /Users/usr/opt/anaconda3/envs/myenv/lib/python3.7/site-packages/google_pasta-0.2.0.dist-info/METADATA\n$ <span># 上のファイルパスはエラー文のコピペ</span>\n$\n$ pip install tensorflow</code></pre>\n<p>さっきまでのエラーが原因であれば、これでインストールが完了しているはずです!</p>\n<p>まあ、今回はconda環境で起こった問題なので、何かしらcondaの中でやってはいけないコマンドか何かがあったのかなって感じです。</p>\n<p>とにかくこのエラーが出たらどうにかなるということで、これからは対処できそうです。</p>\n<p>クリスマスイヴの投稿でした \\o/<br>\nそれでは、楽しく機械学習をハックしていきましょう!!</p>\n","Title":"tensorflowインストール時 METADATAがない？","Date":"2020-12-24","Category":"Python","Tags":["Python","tensorflow"],"Authors":"ゆうぼう","Slug":"tf-install-err","Thumbnail":"/images/thumbnails/python.jpg","Description":"pip install tensorflowでtensorflowをインストールしてディープラーニングをやろうとした矢先の事、パッケージが足りないだと...。その時の解決策がとても簡単だったのですが、この手の問題はtensorflowに限らず起こりそうなので、記録しておきます。","Published":true},{"contentHtml":"<p>今回は、<strong>多次元配列で*演算には注意しないと、バグが起こるよ</strong>ってことを話します。1年Pythonを描き続けましたが知らなかったので、これは共有させていただきますね。Pythonは、ポインタだの参照だのを意識しなくても良い言語だと思うんですが、これは知っておくべきです。</p>\n<h2>実験方法</h2>\n<p>各配列がどの参照をしているかを注目してみましょう。今回の実験は、以下の流れをとります。</p>\n<ol>\n<li>2次元配列を定義 &#x3C;- 様々な方法をとります</li>\n<li>中の配列の0番目append(0)をする</li>\n<li>実験結果の確認</li>\n</ol>\n<p>それでは早速実験です。対話モードにて行います。</p>\n<h2>シンプルに定義</h2>\n<pre><code><span>>>> </span>l = [[], [], []]\n<span>>>> </span>l[<span>0</span>].append(<span>0</span>)\n\n<span>>>> </span>l\n\n[[<span>0</span>], [], []]</code></pre>\n<p>これはおそらく考えていた通りですね。問題なし。</p>\n<h2>+演算で定義</h2>\n<pre><code><span>>>> </span>l = [[]] + [[]] + [[]]\n<span>>>> </span>l[<span>0</span>].append(<span>0</span>)\n\n<span>>>> </span>l\n\n[[<span>0</span>], [], []]</code></pre>\n<p>これも想定した通り。問題なし。</p>\n<h2>*演算で定義</h2>\n<pre><code><span>>>> </span>l = [[]] * <span>3</span>\n<span>>>> </span>l[<span>0</span>].append(<span>0</span>)\n\n<span>>>> </span>l\n\n[[<span>0</span>], [<span>0</span>], [<span>0</span>]]</code></pre>\n<p>......ん？？？？</p>\n<p>全ての要素配列に0が足してありますね...これは知らんかったやつ...</p>\n<h2>*演算に注意!!!</h2>\n<p>*演算で配列を定義する際には注意しましょう。</p>\n<p>シンプルに定義した場合や+によって定義した配列は、それぞれの配列は別のものとして定義されています。</p>\n<p>しかし、*によって定義されたものは、演算対象となった配列の参照そのものさえもコピーされて作られてしまいます。</p>\n<p>まとまった挙動を示して欲しいのであれば問題ないですが、大きなくくりの配列にある要素配列に対しては別々に動いて欲しい場合はかなり注意が必要です。</p>\n<p>このことを知っておくだけでもバグが出た時に冷静に対処できると思うので、ぜひ覚えておきましょう。</p>\n","Title":"【Python】多次元の不用意な*演算には注意!!","Date":"2020-11-27","Category":"Python","Tags":"Python","Authors":"ゆうぼう","Slug":"mul-list-ref","Thumbnail":"/images/thumbnails/python.jpg","Description":"今回は、多次元配列で\\*演算には注意しないと、バグが起こるよってことを話します。1年Pythonを描き続けましたが知らなかったので、これは共有させていただきますね。Pythonは、ポインタだの参照だのを意識しなくても良い言語だと思うんですが、これは知っておくべきです。","Published":true},{"contentHtml":"<p>Pythonで他にはない特殊な書き方といえば、<strong>内包表記</strong>ですかね。Haskellでもかけるみたいな話聞いたことあるけど。実際内包表記は読みやすく、たいてい高速に動くので推奨される書き方と思います。ベンチマークを測ってみたので参考になればと。</p>\n<h2>今回のコード</h2>\n<p>今回速さを測るための指標となるコードは以下になります。</p>\n<p>至ってシンプルなforループが以下です。</p>\n<pre><code>symbols = <span>'$¢£¥€¤'</span>\n<span><span>def</span> <span>non_ascii</span>(<span>c</span>):</span>\n    <span>return</span> c > <span>127</span>\ncodes = []\n<span>for</span> s <span>in</span> symbols:\n    <span>if</span> <span>ord</span>(s) > <span>127</span>:\n        codes.append(<span>ord</span>(s))</code></pre>\n<p>これを下に複数の書き方に対して処理速度を測ります。</p>\n<h2>いざ実験</h2>\n<p>今回試すものが以下になります。</p>\n<ol>\n<li>ただのforループ</li>\n<li>内包表記</li>\n<li>内包表記 + 自作関数(non_adcii)</li>\n<li>filter + lambda</li>\n<li>filter + 自作関数(non_ascii)</li>\n</ol>\n<p>これらに関して測ってみます。\nコードが以下になります。</p>\n<pre><code><span>import</span> timeit\nTIMES = <span>10000</span>\nSETUP = <span>\"\"\"\nsymbols = '$¢£¥€¤'\ndef non_ascii(c):\n    return c > 127\n\"\"\"</span>\n<span><span>def</span> <span>clock</span>(<span>label, cmd</span>):</span>\n    res = timeit.repeat(cmd, setup=SETUP, number=TIMES)\n    <span>print</span>(label, *(<span>'{:.3f}'</span>.<span>format</span>(x) <span>for</span> x <span>in</span> res))\n<span>if</span> __name__ == <span>\"__main__\"</span>:\n    clock(<span>'for-loop        :'</span>, <span>'codes = []\\nfor s in symbols:\\n\\tif ord(s) > 127: codes.append(ord(s))\\ncodes'</span>)\n    clock(<span>'listcomp        :'</span>, <span>'[ord(s) for s in symbols if ord(s) > 127]'</span>)\n    clock(<span>'listcomp + func :'</span>, <span>'[ord(s) for s in symbols if non_ascii(ord(s))]'</span>)\n    clock(<span>'filter + lambda :'</span>, <span>'list(filter(lambda c: c > 127, map(ord, symbols)))'</span>)\n    clock(<span>'filter + func   :'</span>, <span>'list(filter(non_ascii, map(ord, symbols)))'</span>)</code></pre>\n<p>これらから得られる結果がこんな感じです。(人による)</p>\n<pre><code>for-loop        : 0.009 0.009 0.009 0.009 0.009\nlistcomp        : 0.008 0.008 0.008 0.008 0.008\nlistcomp + func : 0.012 0.013 0.013 0.012 0.012\nfilter + lambda : 0.011 0.013 0.012 0.011 0.013\nfilter + func   : 0.014 0.014 0.014 0.014 0.013</code></pre>\n<p>これはまだループも小さいので差はありませんが、安定して早く動いているのは<strong>内包表記</strong>ですね。</p>\n<p>読みやすく、高速に動くことが多い内包表記でした。実際に導入してみてはいかがでしょか。</p>\n<p>今回は実験だけ示して終わります〜〜.</p>\n","Title":"内包表記でパフォーマンスをあげるのだ！","Date":"2020-11-22","Category":"Python","Tags":["Python"],"Author":"ゆうぼう","Slug":"migrate-listcomp","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pythonで他にはない特殊な書き方といえば、内包表記ですかね。Haskellでもかけるみたいな話聞いたことあるけど。実際内包表記は読みやすく、たいてい高速に動くので推奨される書き方と思います。ベンチマークを測ってみたので参考になればと。","Published":true},{"contentHtml":"<p><strong>PythonからUNIXコマンドを使いたい</strong>。そんな時があると思います!(多分滅多にないと思うけど)今回は、「ls」コマンドをPythonスクリプトから実行していこうと思います。</p>\n<h2>subpocessモジュールを利用</h2>\n<p>今回の用件を満たすのに必要なのは、「<strong>subprocessモジュール</strong>」になります。Python3.5から*subprocess.run()*というメソッドでサブプロセスをつなげて、コマンドを走らせるという方法が推奨されているみたい...</p>\n<p>os.systemとかos.spawn*の代用だそうですね</p>\n<p>というわけで、<strong>subprocessモジュール</strong>を使用していきます。</p>\n<p>インポートはそのままです。</p>\n<pre><code><span>import</span> subprocess</code></pre>\n<h2>subprocess.run()で実際に走らせる</h2>\n<p>それでは早速「ls」コマンドを走らせてみましょう。(実行結果はディレクトリ構造に依存するので、人により異なります)</p>\n<pre><code><span>import</span> subprocess\n\nres = subprocess.&#x3C;span <span><span>class</span>=\"<span>function</span>\"><span>run</span>(<span>\n    [<span>'ls'</span>]\n</span>)\n\n<span>print</span>(<span>res</span>)</span></code></pre>\n<p>この実行結果は以下になります。</p>\n<pre><code>CompletedProcess(args=[<span>'ls'</span>], returncode=0)</code></pre>\n<p>特段注意すべきは、コマンドをリスト又はタプルで入力することでしょうか。基本的にスペースを入れることはできません。引数やフラグを足す際に、スペースが必要ならば、リストやタプルにカンマ(,)で区切りましょう。</p>\n<p>と言いますか...ん？？</p>\n<p>ディレクトリ群出てこないんですけど...<br>\nというのも、あくまで返ってくるのは<strong>subprocess.CompletedProcess</strong>クラスだからですね。</p>\n<h2>CompletedProcessをいじってみる</h2>\n<p>実行出来たはずなのに、結果が帰って来ないようじゃ意味がないので中身を開けていきましょう。</p>\n<p>CompletedProcessクラスには以下のメソッドや変数が存在しています。</p>\n<ul>\n<li>.args</li>\n<li>.returncode</li>\n<li>.stdout</li>\n<li>.check_returncode()</li>\n<li>.stderr</li>\n</ul>\n<p>これから先のチェックは、さきのプログラムの続き。returnされたものは<em>res</em>に入っている。</p>\n<pre><code><span>print</span>(res.args)\n<span># >>> ['ls']</span>\n\n<span>print</span>(res.returncode)\n<span># >>> 0</span>\n\n<span>print</span>(res.stdout)\n<span># >>> None</span>\n\n<span>print</span>(res.stderr)\n<span># >>> None</span></code></pre>\n<p>という結果に...</p>\n<p>プログラムが期待通り終了した場合、0が返ってきます。</p>\n<p>ただ、標準出力、標準エラーには<em>None</em>が返ってきていますね。どこにも結果がないのだけど...</p>\n<h2>実行結果をみる!!</h2>\n<p>実は、subprocess.run()には、出力をキャプチャする引数があったみたいです。それが<strong>capture_output</strong>。これをTrueにすると出力が保存されます。</p>\n<pre><code><span>import</span> subprocess\n\nres = subprocess.&#x3C;span <span><span>class</span>=\"<span>function</span>\"><span>run</span>(<span>[<span>'ls'</span>], capture_output=<span>True</span></span>)\n\n<span>print</span>(<span>res</span>)\n# >>> <span>CompletedProcess</span>(<span>args=[<span>'ls'</span>], returncode=<span>0</span>,\nstdout=<span>b'Applications\\nLibrary\\nSystem\\nUsers\\nVolumes\\nbin\\ncores\\ndev\\netc\\nhome\\nopt\\nprivate\\nsbin\\ntmp\\nusr\\nvar\\n'</span>,\nstderr=<span>b''</span></span>)</span></code></pre>\n<p>これで出力をみることができました。</p>\n<p>他にもコマンドを使うことができるので、必要に応じてsubprocessモジュールを使ってみてください。</p>\n<p>今回はこれにて終了！</p>\n","Title":"PythonからUNIXコマンド発出【ls編】","Date":"2020-11-10","Category":"Python","Tags":["Python","subprocess"],"Authors":"ゆうぼう","Slug":"ls-python","Thumbnail":"/images/thumbnails/python.jpg","Description":"PythonからUNIXコマンドを使いたい。そんな時があると思います!(多分滅多にないと思うけど)今回は、「ls」コマンドをPythonスクリプトから実行していこうと思います。","Published":true},{"contentHtml":"<p>FlaskからJSONを返してAPIサーバー風に稼働させていたのですが、なぜかfetchしたJavaScript側でエラーが...なんだこれとなったのですが、バックエンドのPython側のミスでした。何気に気付きにくかったりするので、またミスしたときのために備忘録として残しておきます。</p>\n<p>今回の環境がこちら</p>\n<ul>\n<li>Python-3.8.6</li>\n<li>Flask</li>\n</ul>\n<h2>エラー内容</h2>\n<p>今回起きたエラーがこちらです。</p>\n<pre><code>SyntaxError: Unexpected token o <span>in</span> JSON at position 1</code></pre>\n<p>予期せぬトークンが頭文字にあったらしいです。なんだこれ...<br>\n他の場所では特にエラーなかったのになぜここだけ...</p>\n<p>Pythonの方を確認してみます。</p>\n<h2>Pythonのミス</h2>\n<p>単にPythonのミスでした。ミスの部分だけピックアップします。</p>\n<pre><code><span>@app.route(<span><span>'/test'</span></span>)</span>\n<span><span>def</span> <span>test</span>():</span>\n    obj = {\n        <span>'foo'</span>: <span>'bar'</span>,\n    }\n    \n    <span>return</span> jsonify(obj)</code></pre>\n<p>何気にわかりにくいんです。</p>\n<p><strong>json.dumps()してなかった</strong>......</p>\n<p>めっちゃくだらないミスで萎えますねこれ。</p>\n<p>というわけで、<em>return jsonify</em>する前にしっかりdictをjsonにダンプしておきます。</p>\n<p>改良版が以下。</p>\n<pre><code><span>@app.route(<span><span>'/test'</span></span>)</span>\n<span><span>def</span> <span>test</span>():</span>\n    obj = {\n        <span>'foo'</span>: <span>'bar'</span>,\n    }\n    \n    obj = json.dumps(obj)\n    \n    <span>return</span> jsonify(obj) </code></pre>\n<p>これでもう、フロント側ではエラー起こさせません!!!!</p>\n<p>簡単に直るけど、気付きにくいってやつです。Flask使ってJSONで通信するときは、フロント側でエラーが出たら、JSONを送っているバックエンドも確認すると良いでしょう。</p>\n<p>今回はこれだけです!</p>\n","Title":"【Flask】フロントでUnexpected token!?","Date":"2020-11-08","Category":"Python","Tags":["Python","JSON","Flask"],"Authors":"ゆうぼう","Slug":"flask-json-parse-err","Thumbnail":"/images/thumbnails/python.jpg","Description":"FlaskからJSONを返してAPIサーバー風に稼働させていたのですが、なぜかfetchしたJavaScript側でエラーが...なんだこれとなったのですが、バックエンドのPython側のミスでした。何気に気付きにくかったりするので、またミスしたときのために備忘録として残しておきます。","Published":true},{"contentHtml":"<p>Anacondaは、GUIで操作ができてやりやすいですが、起動もかなりおそくCLIでどうにかならないか<strong>conda create</strong>コマンドを使って環境を立てる事があります。しかし、ノリでEnterを押してしまってPythonのバージョンを指定し忘れることが...。かなりの弊害を生み出します。その際の対処法を共有します。</p>\n<h2>CLIでconda環境を作る方法</h2>\n<p>まずは、CLIで環境を作るコマンドの紹介です。</p>\n<pre><code>conda create -n your-env-name python=3.x</code></pre>\n<p>たったこれだけで環境を建てられます。</p>\n<h2>あ、やってしまった...python=3.x忘れた</h2>\n<p>僕がノリでガガガってコマンド打って最後にやり忘れるやつです。</p>\n<p>押してから気付くのです...<br>\nあ、やってしまった...python=3.xって打つの忘れた...と</p>\n<pre><code>conda create -n your-env-name</code></pre>\n<p>これやっちゃうとすごく焦るんですよね。なんでかっていうとですね</p>\n<pre><code>(base)$ conda create -n typo\n(base)$ conda activate typo\n(typo)$ pip list\nTraceback (most recent call last):\n  File <span>\"/usr/local/bin/pip\"</span>, line 6, <span>in</span> &#x3C;module>\n    from pip._internal.cli.main import main\nModuleNotFoundError: No module named <span>'pip._internal.cli.main'</span></code></pre>\n<p><em>pipがない</em>...だと...!?</p>\n<p>これは困りました。。。しかもこの環境でやると、そこまで自分好みにカスタマイズしていない方は<em>python2</em>がデフォになっていると思います。</p>\n<p>いやぁ困った。</p>\n<h2>【解決策】condaにPythonをインストール</h2>\n<p>condaに<em>Pythonのバージョンを明示した上で</em>インストールすればうまくいきます！！！</p>\n<p>今回は、現状でAnacondaが対応している最新版の<em>Python3.8</em>をインストールします。</p>\n<pre><code>(typo)$ conda install python==3.8\nCollecting package metadata (current_repodata.json): <span>done</span>\nSolving environment: failed with initial frozen solve. Retrying with flexible solve.\nCollecting package metadata (repodata.json): <span>done</span>\nSolving environment: <span>done</span>\n\n<span>## Package Plan ##</span>\n\n  environment location: /Users/slothyubo/opt/anaconda3/envs/blog-tweet\n\n  added / updated specs:\n    - python==3.8\n\n\nThe following packages will be downloaded:\n\n    package                    |            build\n    ---------------------------|-----------------\n    certifi-2020.6.20          |     pyhd3eb1b0_3         155 KB\n    libffi-3.2.1               |    h0a44026_1007          43 KB\n    python-3.8.0               |       h359304d_2        18.8 MB\n    ------------------------------------------------------------\n                                           Total:        19.0 MB\n\nThe following NEW packages will be INSTALLED:\n\n  ca-certificates    pkgs/main/osx-64::ca-certificates-2020.10.14-0\n  certifi            pkgs/main/noarch::certifi-2020.6.20-pyhd3eb1b0_3\n  libcxx             pkgs/main/osx-64::libcxx-10.0.0-1\n  libedit            pkgs/main/osx-64::libedit-3.1.20191231-h1de35cc_1\n  libffi             pkgs/main/osx-64::libffi-3.2.1-h0a44026_1007\n  ncurses            pkgs/main/osx-64::ncurses-6.2-h0a44026_1\n  openssl            pkgs/main/osx-64::openssl-1.1.1h-haf1e3a3_0\n  pip                pkgs/main/osx-64::pip-20.2.4-py38_0\n  python             pkgs/main/osx-64::python-3.8.0-h359304d_2\n  readline           pkgs/main/osx-64::readline-7.0-h1de35cc_5\n  setuptools         pkgs/main/osx-64::setuptools-50.3.0-py38h0dc7051_1\n  sqlite             pkgs/main/osx-64::sqlite-3.33.0-hffcf06c_0\n  tk                 pkgs/main/osx-64::tk-8.6.10-hb0a8c7a_0\n  wheel              pkgs/main/noarch::wheel-0.35.1-py_0\n  xz                 pkgs/main/osx-64::xz-5.2.5-h1de35cc_0\n  zlib               pkgs/main/osx-64::zlib-1.2.11-h1de35cc_3\n\n\nProceed ([y]/n)? y  <span># &#x3C;== yでEnter</span>\n\nDownloading and Extracting Packages\npython-3.8.0         | 18.8 MB   | <span>######################################################### | 100% </span>\nlibffi-3.2.1         | 43 KB     | <span>######################################################### | 100% </span>\ncertifi-2020.6.20    | 155 KB    | <span>######################################################### | 100% </span>\nPreparing transaction: <span>done</span>\nVerifying transaction: <span>done</span>\nExecuting transaction: <span>done</span></code></pre>\n<p>このようになり、インストールされました。</p>\n<p>また途中でpipも同時にインストールされており、これで無事にpipもインストールされるようになりました！</p>\n<p>確認</p>\n<pre><code>(typo)$ pip --version\npip 20.0.2 from /Users/user/opt/anaconda3/envs/static-site/lib/python3.7/site-packages/pip (python 3.7)</code></pre>\n<p>上記は人によりますが、しっかりpipが使えますね</p>\n<p>それでは、もし<strong>conda create</strong>でPythonのバージョンを書き忘れたら、これで解決しましょう！</p>\n","Title":"conda createでpythonのバージョン指定忘れた！","Date":"2020-11-01","Category":"Python","Tags":["Python","conda"],"Authors":"ゆうぼう","Slug":"conda-miss-pythonv","Thumbnail":"/images/thumbnails/python.jpg","Description":"Anacondaは、GUIで操作ができてやりやすいですが、起動もかなりおそくCLIでどうにかならないか「conda create」コマンドを使って環境を立てる事があります。しかし、ノリでEnterを押してしまってPythonのバージョンを指定し忘れることが...。かなりの弊害を生み出します。その際の対処法を共有します。","Published":true},{"contentHtml":"<p>Pythonにも<strong>map関数</strong>があり、容易に配列から新たな配列を生み出すことができます。<em>lambda</em>を用いて無名関数を使うなど、いくつか応用方があるので備忘録がてらまとめていこうと思います。</p>\n<p>簡単のため、<em>ある配列の全ての要素の絶対値をとる</em>スクリプトで試します。</p>\n<h2>mapと無名関数</h2>\n<p>新たに配列から配列を作るために忘れてはいけないのは、<strong>mapオブジェクトをlistで囲むこと</strong>です。</p>\n<p>その点を考慮しつつ、新たな配列を生み出していきます。まずは、無名関数<em>lambda</em>を使います。</p>\n<pre><code>a = [-<span>3</span>, -<span>2</span>, -<span>1</span>, <span>0</span>, <span>1</span>, <span>2</span>, <span>3</span>]\nto_abs = <span>lambda</span> x: <span>abs</span>(x)\n\nb = <span>list</span>(<span>map</span>(to_abs, a))\n<span>print</span>(b)</code></pre>\n<pre><code>[3, 2, 1, 0, 1, 2, 3]</code></pre>\n<p>無名関数<em>to_abs</em>により、渡される各関数の値の絶対値を返します。</p>\n<h2>mapと普段使いの関数</h2>\n<p>普段通りの関数宣言でも動きます。</p>\n<pre><code><span><span>def</span> <span>to_abs</span>(<span>x</span>):</span>\n    <span>return</span> <span>abs</span>(x)\n    \nc = <span>list</span>(<span>map</span>(to_abs, a))\n<span>print</span>(c)</code></pre>\n<pre><code>[3, 2, 1, 0, 1, 2, 3]</code></pre>\n<p>普通に動きますが、ここで注意したいのは<strong>mapに渡す関数に直接的に引数を与えないこと</strong>です。</p>\n<p>そうすることで難なく動きます。</p>\n<p>引数を渡してみるとどうなるでしょうか。</p>\n<pre><code><span><span>def</span> <span>to_abs</span>(<span>x</span>):</span>\n    <span>return</span> <span>abs</span>(x)\n    \nc = <span>list</span>(<span>map</span>(to_abs(x), a))\n<span>print</span>(c)</code></pre>\n<pre><code>Traceback (most recent call last):\n  File <span>\"map.py\"</span>, line 3, <span>in</span> &#x3C;module>\n    c = list(map(to_abs(x), a))\nNameError: name <span>'x'</span> is not defined</code></pre>\n<p>参照する<em>x</em>がないのでエラーが発生します。その点だけ注意しましょう。</p>\n<h2>mapでsetに応用</h2>\n<p>setについても同様に動作します</p>\n<pre><code>d = <span>set</span>(<span>map</span>(to_abs, a))\n<span>print</span>(d)</code></pre>\n<pre><code>{0, 1, 2, 3}</code></pre>\n<p>しっかりと集合として捉えられていますね。</p>\n<p>mapを使ってさせることはそこまで難しくないですが、処理速度的にはおそらく内包表記の方が速いと思われるので場合に合わせて導入するのが良いかもしれません。</p>\n<p>ただ、numpyやpandasでデータ分析をする際は、map関数がそれぞれで与えられていることもあるので、使えるに越したことはないでしょう。</p>\n","Title":"【map】を使って新たな配列を作る","Date":"2020-10-26","Category":"Python","Tags":["Python","map"],"Authors":"ゆうぼう","Slug":"py-map","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pythonにもmap関数があり、容易に配列から新たな配列を生み出すことができます。lambdaを用いて無名関数を使うなど、いくつか応用方があるので備忘録がてらまとめていこうと思います。","Published":true},{"contentHtml":"<p>Pythonには<strong>デコレータ</strong>というものがあるのですが、意外と初学者には知られていない存在で比較的不思議な挙動をする感じがします。関数を直接的に実行しなくともファイルを読み込んだ段階で実行されるようなので、挙動について実験してみました。</p>\n<h2>デコレータ活用例</h2>\n<p>まずは、デコレータの活用例をお話しします。(Numpyから借用)</p>\n<p>Numpyにおいては、関数のモジュールを<em>numpy</em>に変更しており、override.pyか_override.pyだかに<em>set_module</em>関数が作られていたと思います(ちょっと曖昧)</p>\n<p>適当な関数を定義してモジュールを変更します。</p>\n<pre><code><span><span>def</span> <span>set_module</span>(<span>name</span>):</span>\n    <span><span>def</span> <span>decorator</span>(<span>func</span>):</span>\n        func.__module__ = name\n        <span>return</span> func\n    <span>return</span> decorator\n    \n<span><span>def</span> <span>check_module</span>(<span>func</span>):</span>\n    <span>print</span>(func.__module__)\n    \n<span>@set_module(<span><span>'mylib'</span></span>)    </span><span># module名書き換え</span>\n<span><span>def</span> <span>changed</span>():</span>\n    <span>pass</span>\n    \n<span># module名変更なし</span>\n<span><span>def</span> <span>not_changed</span>():</span>\n    <span>pass</span>\n    \n<span>if</span> __name__ == <span>'__main__'</span>:\n    check_module(changed)\n    check_module(not_changed)</code></pre>\n<p>各関数の役割</p>\n<ul>\n<li>set_module\n<ul>\n<li>デコレータ</li>\n<li>関数のモジュール名を変更する</li>\n</ul>\n</li>\n<li>changed\n<ul>\n<li>モジュール名を変更される関数</li>\n</ul>\n</li>\n<li>not_changed\n<ul>\n<li>モジュール名を<strong>変更されない</strong>関数</li>\n</ul>\n</li>\n</ul>\n<p>これらの実行結果が以下になります。</p>\n<pre><code>mylib\n__main__</code></pre>\n<p>変更された方は、期待した通りモジュール名が<em>mylib</em>に変わっていて、変更していない方はメインルーティンに入っていることになっています。</p>\n<h2>デコレータの挙動を追う</h2>\n<p>デコレータの挙動を追ってみます。基本的には動作がわかるように関数に機能はつけず、標準出力にて動作を確認していきます。</p>\n<p>実験するための関数を用意します。</p>\n<pre><code><span><span>def</span> <span>deco</span>(<span>name</span>):</span>\n    <span>print</span>(name, <span>'開始'</span>)\n    <span><span>def</span> <span>decorator</span>(<span>func</span>):</span>\n        <span>print</span>(func.__name__, <span>'実行'</span>)\n        <span>return</span> func\n    <span>print</span>(name, <span>'終了'</span>)\n    <span>return</span> decorator\n    \n<span>@deco(<span><span>'deco1'</span></span>)</span>\n<span><span>def</span> <span>test1</span>():</span>\n    <span>pass</span>\n    \n<span>if</span> __name__ == <span>\"__main__\"</span>:\n    <span>pass</span></code></pre>\n<p>特別難しいこともありません。ただ各タイミングで出力を待つデコレータです。</p>\n<p>実行結果が以下になります。</p>\n<pre><code>deco1 開始\ndeco1 終了\ntest1 実行</code></pre>\n<p>デコレータの外の関数を動かした後、デコレートされた(装飾された)関数が返されるという感じです。</p>\n<p>流れは以下になります。</p>\n<ol>\n<li>デコレータの発火</li>\n<li>デコレータにより関数を装飾</li>\n<li>装飾された関数が返ってくる</li>\n<li>あとは3の関数を使うだけ</li>\n</ol>\n<p>このような流れになっていきます。デコレータは関数を装飾するものなので、ちょっと特殊であまり使うことがない気もしますが...</p>\n<p>また、<strong>メインルーティンで何も動かしていないのにもかかわらず</strong>、出力されています。</p>\n<p>デコレータは読み込んだときに動くようです。その特徴がわかればそこまでデコレータは難しいものでもなさそうです。</p>\n<p>あとでまた多重デコレータに関する話をしたいと思います。</p>\n","Title":"Pythonのデコレータの挙動を実験してみた","Date":"2020-10-26","Category":"Python","Tags":["Python","デコレータ"],"Authors":"ゆうぼう","Slug":"decorator-timing","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pythonにはデコレータというものがあるのですが、意外と初学者には知られていない存在で比較的不思議な挙動をする感じがします。関数を直接的に実行しなくともファイルを読み込んだ段階で実行されるようなので、挙動について実験してみました。","Published":true},{"contentHtml":"<p>Pythonを使って、例えばコーパスを作る際、辞書型に対して単語出現回数を記録しするなど、辞書を使うことがあるかもしれません。その際、ifによる条件分岐によって辞書型の初期化をするわけですが、collectionsにあるdefaultdictというものを使うと初期化を勝手にやってくれます。そのdefaultdictについて解説していきます。</p>\n<p>今回は、Wikipediaの「AI」に関するページの一部文章に関して単語出現回数を数えていきます。</p>\n<h2>文章を単語ごとに分割する</h2>\n<p>まずは手始めに文章を単語ごとに分割していきます。</p>\n<p>使用する文章がこちらです。</p>\n<p>Artificial intelligence (AI), is intelligence demonstrated by machines, unlike the natural intelligence displayed by humans and animals. Leading AI textbooks define the field as the study of \"intelligent agents\": any device that perceives its environment and takes actions that maximize its chance of successfully achieving its goals. Colloquially, the term \"artificial intelligence\" is often used to describe machines (or computers) that mimic \"cognitive\" functions that humans associate with the human mind, such as \"learning\" and \"problem solving\".</p>\n<p>As machines become increasingly capable, tasks considered to require \"intelligence\" are often removed from the definition of AI, a phenomenon known as the AI effect. A quip in Tesler's Theorem says \"AI is whatever hasn't been done yet.\" For instance, optical character recognition is frequently excluded from things considered to be AI, having become a routine technology. Modern machine capabilities generally classified as AI include successfully understanding human speech, competing at the highest level in strategic game systems (such as chess and Go), autonomously operating cars, intelligent routing in content delivery networks, and military simulations.</p>\n<p>Artificial intelligence was founded as an academic discipline in 1955, and in the years since has experienced several waves of optimism, followed by disappointment and the loss of funding (known as an \"AI winter\"), followed by new approaches, success and renewed funding. For most of its history, AI research has been divided into sub-fields that often fail to communicate with each other. These sub-fields are based on technical considerations, such as particular goals (e.g. \"robotics\" or \"machine learning\"), the use of particular tools (\"logic\" or artificial neural networks), or deep philosophical differences. Sub-fields have also been based on social factors (particular institutions or the work of particular researchers).</p>\n<p>The traditional problems (or goals) of AI research include reasoning, knowledge representation, planning, learning, natural language processing, perception and the ability to move and manipulate objects. General intelligence is among the field's long-term goals. Approaches include statistical methods, computational intelligence, and traditional symbolic AI. Many tools are used in AI, including versions of search and mathematical optimization, artificial neural networks, and methods based on statistics, probability and economics. The AI field draws upon computer science, information engineering, mathematics, psychology, linguistics, philosophy, and many other fields.</p>\n<p>The field was founded on the assumption that human intelligence \"can be so precisely described that a machine can be made to simulate it\". This raises philosophical arguments about the mind and the ethics of creating artificial beings endowed with human-like intelligence. These issues have been explored by myth, fiction and philosophy since antiquity. Some people also consider AI to be a danger to humanity if it progresses unabated. Others believe that AI, unlike previous technological revolutions, will create a risk of mass unemployment.</p>\n<p>In the twenty-first century, AI techniques have experienced a resurgence following concurrent advances in computer power, large amounts of data, and theoretical understanding; and AI techniques have become an essential part of the technology industry, helping to solve many challenging problems in computer science, software engineering and operations research.</p>\n<p>こちらを分割します。</p>\n<p><em>content</em>という変数に上記の文章が入っていることを想定しています。</p>\n<pre><code><span>import</span> re\nwords = re.split(<span>'[,\\.\"\\(\\)\\s+]'</span>, content)\nwords = [word <span>for</span> word <span>in</span> words <span>if</span> <span>not</span> word==<span>''</span>]</code></pre>\n<p>1行目で「, . \" ( ) 空白」を区切りとして単語分けしています。これで空白が取り切れないので、2行目で空文字になってしまったものを削除します。</p>\n<h2>初期化をサボってカウントする</h2>\n<p>それでは初期化をサボって単語出現回数をカウントしていきます。</p>\n<pre><code><span>from</span> collections <span>import</span> defaultdict\n\nfreq = defaultdict(<span>int</span>)\n<span>for</span> word <span>in</span> words:\n     freq[word] += <span>1</span></code></pre>\n<p>たったこれでだけで、ifによる条件分岐なしにカウントができます。結果をみてみてもしっかりカウントされていることがわかります。</p>\n<pre><code>&#x3C;span <span><span>class</span>=\"<span>builtins</span>\"><span>print</span>(<span>freq</span>)\n</span></code></pre>\n<pre><code>defaultdict(&#x3C;\\class <span>'int'</span>>, {<span>'Artificial'</span>: 2, <span>'intelligence'</span>: 10, <span>'AI'</span>: 17, <span>'is'</span>: 5, <span>'demonstrated'</span>: 1, <span>'by'</span>: 5, <span>'machines'</span>: 3, <span>'unlike'</span>: 2,\n<span>'the'</span>: 19, <span>'natural'</span>: 2, <span>'displayed'</span>: 1, <span>'humans'</span>: 2, <span>'and'</span>: 20, <span>'animals'</span>: 1, <span>'Leading'</span>: 1, <span>'textbooks'</span>: 1, <span>'define'</span>: 1, <span>'field'</span>: 3, <span>'as'</span>:\n8, <span>'study'</span>: 1, <span>'of'</span>: 14, <span>'intelligent'</span>: 2, <span>'agents'</span>: 1, <span>':'</span>: 1, <span>'any'</span>: 1, <span>'device'</span>: 1, <span>'that'</span>: 8, <span>'perceives'</span>: 1, <span>'its'</span>: 4, <span>'environment'</span>:\n1, <span>'takes'</span>: 1, <span>'actions'</span>: 1, <span>'maximize'</span>: 1, <span>'chance'</span>: 1, <span>'successfully'</span>: 2, <span>'achieving'</span>: 1, <span>'goals'</span>: 4, <span>'Colloquially'</span>: 1, <span>'term'</span>: 1,\n<span>'artificial'</span>: 4, <span>'often'</span>: 3, <span>'used'</span>: 2, <span>'to'</span>: 9, <span>'describe'</span>: 1, <span>'or'</span>: 6, <span>'computers'</span>: 1, <span>'mimic'</span>: 1, <span>'cognitive'</span>: 1, <span>'functions'</span>: 1,\n<span>'associate'</span>: 1, <span>'with'</span>: 3, <span>'human'</span>: 3, <span>'mind'</span>: 2, <span>'such'</span>: 3, <span>'learning'</span>: 3, <span>'problem'</span>: 1, <span>'solving'</span>: 1, <span>'As'</span>: 1, <span>'become'</span>: 3,\n<span>'increasingly'</span>: 1, <span>'capable'</span>: 1, <span>'tasks'</span>: 1, <span>'considered'</span>: 2, <span>'require'</span>: 1, <span>'are'</span>: 3, <span>'removed'</span>: 1, <span>'from'</span>: 2, <span>'definition'</span>: 1, <span>'a'</span>:\n6, <span>'phenomenon'</span>: 1, <span>'known'</span>: 2, <span>'effect'</span>: 1, <span>'A'</span>: 1, <span>'quip'</span>: 1, <span>'in'</span>: 8, <span>\"Tesler's\"</span>: 1, <span>'Theorem'</span>: 1, <span>'says'</span>: 1, <span>'whatever'</span>: 1,\n<span>\"hasn't\"</span>: 1, <span>'been'</span>: 4, <span>'done'</span>: 1, <span>'yet'</span>: 1, <span>'For'</span>: 2, <span>'instance'</span>: 1, <span>'optical'</span>: 1, <span>'character'</span>: 1, <span>'recognition'</span>: 1, <span>'frequently'</span>:\n1, <span>'excluded'</span>: 1, <span>'things'</span>: 1, <span>'be'</span>: 4, <span>'having'</span>: 1, <span>'routine'</span>: 1, <span>'technology'</span>: 2, <span>'Modern'</span>: 1, <span>'machine'</span>: 3, <span>'capabilities'</span>: 1,\n<span>'generally'</span>: 1, <span>'classified'</span>: 1, <span>'include'</span>: 3, <span>'understanding'</span>: 1, <span>'speech'</span>: 1, <span>'competing'</span>: 1, <span>'at'</span>: 1, <span>'highest'</span>: 1, <span>'level'</span>: 1,\n<span>'strategic'</span>: 1, <span>'game'</span>: 1, <span>'systems'</span>: 1, <span>'chess'</span>: 1, <span>'Go'</span>: 1, <span>'autonomously'</span>: 1, <span>'operating'</span>: 1, <span>'cars'</span>: 1, <span>'routing'</span>: 1,\n<span>'content'</span>: 1, <span>'delivery'</span>: 1, <span>'networks'</span>: 3, <span>'military'</span>: 1, <span>'simulations'</span>: 1, <span>'was'</span>: 2, <span>'founded'</span>: 2, <span>'an'</span>: 3, <span>'academic'</span>: 1,\n<span>'discipline'</span>: 1, <span>'1955'</span>: 1, <span>'years'</span>: 1, <span>'since'</span>: 2, <span>'has'</span>: 2, <span>'experienced'</span>: 2, <span>'several'</span>: 1, <span>'waves'</span>: 1, <span>'optimism'</span>: 1,\n<span>'followed'</span>: 2, <span>'disappointment'</span>: 1, <span>'loss'</span>: 1, <span>'funding'</span>: 2, <span>'winter'</span>: 1, <span>'new'</span>: 1, <span>'approaches'</span>: 1, <span>'success'</span>: 1, <span>'renewed'</span>:\n1, <span>'most'</span>: 1, <span>'history'</span>: 1, <span>'research'</span>: 3, <span>'divided'</span>: 1, <span>'into'</span>: 1, <span>'sub-fields'</span>: 2, <span>'fail'</span>: 1, <span>'communicate'</span>: 1, <span>'each'</span>: 1,\n<span>'other'</span>: 2, <span>'These'</span>: 2, <span>'based'</span>: 3, <span>'on'</span>: 4, <span>'technical'</span>: 1, <span>'considerations'</span>: 1, <span>'particular'</span>: 4, <span>'e'</span>: 1, <span>'g'</span>: 1,\n<span>'robotics'</span>: 1, <span>'use'</span>: 1, <span>'tools'</span>: 2, <span>'logic'</span>: 1, <span>'neural'</span>: 2, <span>'deep'</span>: 1, <span>'philosophical'</span>: 2, <span>'differences'</span>: 1,\n<span>'Sub-fields'</span>: 1, <span>'have'</span>: 4, <span>'also'</span>: 2, <span>'social'</span>: 1, <span>'factors'</span>: 1, <span>'institutions'</span>: 1, <span>'work'</span>: 1, <span>'researchers'</span>: 1, <span>'The'</span>:\n3, <span>'traditional'</span>: 2, <span>'problems'</span>: 2, <span>'reasoning'</span>: 1, <span>'knowledge'</span>: 1, <span>'representation'</span>: 1, <span>'planning'</span>: 1, <span>'language'</span>: 1,\n<span>'processing'</span>: 1, <span>'perception'</span>: 1, <span>'ability'</span>: 1, <span>'move'</span>: 1, <span>'manipulate'</span>: 1, <span>'objects'</span>: 1, <span>'General'</span>: 1, <span>'among'</span>: 1,\n<span>\"field's\"</span>: 1, <span>'long-term'</span>: 1, <span>'Approaches'</span>: 1, <span>'statistical'</span>: 1, <span>'methods'</span>: 2, <span>'computational'</span>: 1, <span>'symbolic'</span>: 1,\n<span>'Many'</span>: 1, <span>'including'</span>: 1, <span>'versions'</span>: 1, <span>'search'</span>: 1, <span>'mathematical'</span>: 1, <span>'optimization'</span>: 1, <span>'statistics'</span>: 1,\n<span>'probability'</span>: 1, <span>'economics'</span>: 1, <span>'draws'</span>: 1, <span>'upon'</span>: 1, <span>'computer'</span>: 3, <span>'science'</span>: 2, <span>'information'</span>: 1,\n<span>'engineering'</span>: 2, <span>'mathematics'</span>: 1, <span>'psychology'</span>: 1, <span>'linguistics'</span>: 1, <span>'philosophy'</span>: 2, <span>'many'</span>: 2, <span>'fields'</span>: 1,\n<span>'assumption'</span>: 1, <span>'can'</span>: 2, <span>'so'</span>: 1, <span>'precisely'</span>: 1, <span>'described'</span>: 1, <span>'made'</span>: 1, <span>'simulate'</span>: 1, <span>'it'</span>: 2, <span>'This'</span>: 1,\n<span>'raises'</span>: 1, <span>'arguments'</span>: 1, <span>'about'</span>: 1, <span>'ethics'</span>: 1, <span>'creating'</span>: 1, <span>'beings'</span>: 1, <span>'endowed'</span>: 1, <span>'human-like'</span>: 1,\n<span>'issues'</span>: 1, <span>'explored'</span>: 1, <span>'myth'</span>: 1, <span>'fiction'</span>: 1, <span>'antiquity'</span>: 1, <span>'Some'</span>: 1, <span>'people'</span>: 1, <span>'consider'</span>: 1,\n<span>'danger'</span>: 1, <span>'humanity'</span>: 1, <span>'if'</span>: 1, <span>'progresses'</span>: 1, <span>'unabated'</span>: 1, <span>'Others'</span>: 1, <span>'believe'</span>: 1, <span>'previous'</span>: 1,\n<span>'technological'</span>: 1, <span>'revolutions'</span>: 1, <span>'will'</span>: 1, <span>'create'</span>: 1, <span>'risk'</span>: 1, <span>'mass'</span>: 1, <span>'unemployment'</span>: 1, <span>'In'</span>: 1,\n<span>'twenty-first'</span>: 1, <span>'century'</span>: 1, <span>'techniques'</span>: 2, <span>'resurgence'</span>: 1, <span>'following'</span>: 1, <span>'concurrent'</span>: 1,\n<span>'advances'</span>: 1, <span>'power'</span>: 1, <span>'large'</span>: 1, <span>'amounts'</span>: 1, <span>'data'</span>: 1, <span>'theoretical'</span>: 1, <span>'understanding;'</span>: 1,\n<span>'essential'</span>: 1, <span>'part'</span>: 1, <span>'industry'</span>: 1, <span>'helping'</span>: 1, <span>'solve'</span>: 1, <span>'challenging'</span>: 1, <span>'software'</span>: 1,\n<span>'operations'</span>: 1})</code></pre>\n<p>これで簡単に単語数カウントができます。</p>\n<p>今回は単語数カウントを題材にしましたが、違う初期化方法を指定してあげれば他のことも可能になりますで試してみては。</p>\n","Title":"【defaultdict】で辞書型の初期化をサボる","Date":"2020-10-19","Category":"Python","Tags":"Python","Authors":"ゆうぼう","Slug":"defaultdict-usage","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pythonを使って、例えばコーパスを作る際、辞書型に対して単語出現回数を記録しするなど、辞書を使うことがあるかもしれません。その際、ifによる条件分岐によって辞書型の初期化をするわけですが、collectionsにあるdefaultdictというものを使うと初期化を勝手にやってくれます。そのdefaultdictについて解説していきます。","Published":true},{"contentHtml":"<p>Pythonで中身をpopで削除したいなーと思った時、なぜか「<em>dictionary changed size during iteration</em>」とのメッセージが。これは意外と出てきたら原因がパッとしないので、2度と同じことを起こさないように記録しておきます。</p>\n<h2>直感的にイテレーションしてpopしていく</h2>\n<p>ここでは、直感的に初心者が思いつきそうな感じのイテレーションを用いてループを回し、popで辞書を消していきます。</p>\n<pre><code>dictionary = {\n    <span>'a'</span>: <span>0</span>,\n    <span>'b'</span>: <span>1</span>,\n    <span>'c'</span>: <span>2</span>,\n}\n\n<span>for</span> key <span>in</span> dictionary.keys():\n    dictionary.pop(key)</code></pre>\n<p>結果はこんな感じに...</p>\n<pre><code>Traceback (most recent call last):\n  File <span>\"&#x3C;stdin>\"</span>, line 6, <span>in</span> &#x3C;module>\nRuntimeError: dictionary changed size during iteration</code></pre>\n<p>は？<em>RuntimeError</em>だと...!?</p>\n<p><strong>イテレーション中に辞書のサイズ変わったんですけど</strong>と怒られたわけです。</p>\n<p>ということは、<strong>keys()を使っていながら、ループの内部で辞書をいじってはいけない</strong>ということになりますね。</p>\n<h2>keys()をリストとして先に確保してしまえ!!</h2>\n<p>さて、解決していきます。</p>\n<p>イテレーション中の辞書を書き換えてはいけなかったので、*list()*にしてしまお〜〜<br>\nということで、キーのイテレータは配列として別物と扱わせます。</p>\n<p>少しだけ変えた奴が下。</p>\n<pre><code>dictionary = {\n    <span>'a'</span>: <span>0</span>,\n    <span>'b'</span>: <span>1</span>,\n    <span>'c'</span>: <span>2</span>,\n}\n\n<span>for</span> key <span>in</span> <span>list</span>(dictionary.keys()):    &#x3C;=変えるのはここ\n    dictionary.pop(key)</code></pre>\n<p>これで、出力も足してみます。</p>\n<pre><code><span>print</span>(a)</code></pre>\n<p>結果が以下になります。</p>\n<pre><code>1</code></pre>\n<p>お〜動きましたね。</p>\n<p>というわけで、辞書型でイテレーションを用いて何かするときは、配列とかで切り離して使ってあげるとエラーなくコードが動きますよ〜</p>\n<p>今後は僕も気をつけたいと思います。</p>\n","Title":"dictionary changed size during iterationの原因特定した","Date":"2020-10-18","Category":"Python","Tags":"Python","Authors":"ゆうぼう","Slug":"py-dict-iter-err","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pythonで中身をpopで削除したいなーと思った時、なぜか「dictionary changed size during iteration」とのメッセージが。これは意外と出てきたら原因がパッとしないので、2度と同じことを起こさないように記録しておきます。","Published":true},{"contentHtml":"<h2>ソート対象とする辞書の確認</h2>\n<p>まずは辞書を確認します。今回使用する辞書型は、ある文書に出現した単語と出現回数を示す<em>freq_words</em>という辞書としましょう。</p>\n<p>その中身は次になります。</p>\n<p>このデータを作成には、辞書の初期化を簡単に行ってくれる<em>collections.defaultdict</em>を使用しています。こちらの使い方と今回使用する辞書の生成は別記事で行っているので、そちらを別途参照されたい。<a href=\"https://yuta0306.github.io/blog/defaultdict-usage\">【defaultdict】で辞書型の初期化をサボる</a></p>\n<pre><code>defaultdict(&#x3C;<span><span>class</span> '<span>int</span>'>, {'<span>Python</span>':</span> <span>23</span>, <span>'-'</span>: <span>1</span>, <span>'Wikipedia'</span>: <span>3</span>, <span>'From'</span>: <span>1</span>, <span>'Wikipedia,'</span>: <span>1</span>, <span>'the'</span>: <span>15</span>, <span>'free'</span>: <span>2</span>, <span>'encyclopedia'</span>: <span>1</span>, <span>'Jump'</span>: <span>2</span>, <span>'to'</span>: <span>9</span>, <span>'navigation'</span>: <span>1</span>, <span>'search'</span>: <span>2</span>, <span>'Look'</span>: <span>1</span>, <span>'up'</span>: <span>1</span>, <span>'or'</span>: <span>3</span>, <span>'python'</span>: <span>1</span>, <span>'in'</span>: <span>7</span>, <span>'Wiktionary,'</span>: <span>1</span>, <span>'dictionary.'</span>: <span>1</span>, <span>'may'</span>: <span>3</span>, <span>'refer'</span>: <span>1</span>, <span>'to:'</span>: <span>1</span>, <span>'Pythons'</span>: <span>1</span>, <span>'Pythonidae,'</span>: <span>1</span>, <span>'a'</span>: <span>19</span>, <span>'family'</span>: <span>1</span>, <span>'of'</span>: <span>12</span>, <span>'nonvenomous'</span>: <span>2</span>, <span>'snakes'</span>: <span>1</span>, <span>'found'</span>: <span>2</span>, <span>'Africa,'</span>: <span>1</span>, <span>'Asia,'</span>: <span>1</span>, <span>'and'</span>: <span>3</span>, <span>'Australia'</span>: <span>1</span>, <span>'genus,'</span>: <span>1</span>, <span>'genus'</span>: <span>1</span>, <span>'Pythonidae'</span>: <span>1</span>, <span>'Africa'</span>: <span>1</span>, <span>'Asia'</span>: <span>1</span>, <span>'Contents'</span>: <span>1</span>, <span>'1'</span>: <span>1</span>, <span>'Computing'</span>: <span>1</span>, <span>'2'</span>: <span>1</span>, <span>'People'</span>: <span>1</span>, <span>'3'</span>: <span>2</span>, <span>'Roller'</span>: <span>2</span>, <span>'coasters'</span>: <span>1</span>, <span>'4'</span>: <span>1</span>, <span>'Vehicles'</span>: <span>1</span>, <span>'5'</span>: <span>1</span>, <span>'Weaponry'</span>: <span>1</span>, <span>'6'</span>: <span>1</span>, <span>'Other'</span>: <span>2</span>, <span>'uses'</span>: <span>1</span>, <span>'7'</span>: <span>1</span>, <span>'See'</span>: <span>2</span>, <span>'also'</span>: <span>1</span>, <span>'Computing[edit]'</span>: <span>1</span>, <span>'programming'</span>: <span>1</span>, <span>'language'</span>: <span>1</span>, <span>'Python,'</span>: <span>3</span>, <span>'native'</span>: <span>1</span>, <span>'code'</span>: <span>1</span>, <span>'compiler'</span>: <span>1</span>, <span>'for'</span>: <span>2</span>, <span>'CMU'</span>: <span>1</span>, <span>'Common'</span>: <span>1</span>, <span>'Lisp'</span>: <span>1</span>, <span>'internal'</span>: <span>2</span>, <span>'project'</span>: <span>1</span>, <span>'name'</span>: <span>3</span>, <span>'PERQ'</span>: <span>1</span>, <span>'computer'</span>: <span>1</span>, <span>'workstation'</span>: <span>1</span>, <span>'People[edit]'</span>: <span>1</span>, <span>'Aenus'</span>: <span>1</span>, <span>'4th-century'</span>: <span>1</span>, <span>'BCE,'</span>: <span>1</span>, <span>'student'</span>: <span>1</span>, <span>'Plato'</span>: <span>1</span>, <span>'painter,'</span>: <span>1</span>, <span>'ca.'</span>: <span>1</span>, <span>'360-320'</span>: <span>1</span>, <span>'BCE'</span>: <span>1</span>, <span>'vase'</span>: <span>1</span>, <span>'painter'</span>: <span>1</span>, <span>'Poseidonia'</span>: <span>1</span>, <span>'Byzantium,'</span>: <span>1</span>, <span>'orator,'</span>: <span>1</span>, <span>'diplomat'</span>: <span>1</span>, <span>'Philip'</span>: <span>1</span>, <span>'II'</span>: <span>1</span>, <span>'Macedon'</span>: <span>1</span>, <span>'Catana,'</span>: <span>1</span>, <span>'poet'</span>: <span>1</span>, <span>'who'</span>: <span>1</span>, <span>'accompanied'</span>: <span>1</span>, <span>'Alexander'</span>: <span>1</span>, <span>'Great'</span>: <span>1</span>, <span>'Anghelo'</span>: <span>1</span>, <span>'1954–2014'</span>: <span>1</span>, <span>'Romanian'</span>: <span>1</span>, <span>'graphic'</span>: <span>1</span>, <span>'artist'</span>: <span>1</span>, <span>'coasters[edit]'</span>: <span>1</span>, <span>'Efteling,'</span>: <span>1</span>, <span>'roller'</span>: <span>3</span>, <span>'coaster'</span>: <span>3</span>, <span>'Netherlands'</span>: <span>1</span>, <span>'Busch'</span>: <span>1</span>, <span>'Gardens'</span>: <span>1</span>, <span>'Tampa'</span>: <span>1</span>, <span>'Bay,'</span>: <span>1</span>, <span>'defunct'</span>: <span>1</span>, <span>'Coney'</span>: <span>1</span>, <span>'Island,'</span>: <span>1</span>, <span>'Cincinnati,'</span>: <span>1</span>, <span>'Ohio,'</span>: <span>1</span>, <span>'steel'</span>: <span>1</span>, <span>'Vehicles[edit]'</span>: <span>1</span>, <span>'automobile'</span>: <span>1</span>, <span>'maker,'</span>: <span>1</span>, <span>'an'</span>: <span>2</span>, <span>'Australian'</span>: <span>1</span>, <span>'car'</span>: <span>2</span>, <span>'company'</span>: <span>2</span>, <span>'Ford'</span>: <span>1</span>, <span>'prototype,'</span>: <span>1</span>, <span>'Ford'</span>: <span>1</span>, <span>'prototype'</span>: <span>1</span>, <span>'sports'</span>: <span>1</span>, <span>'Weaponry[edit]'</span>: <span>1</span>, <span>'missile,'</span>: <span>1</span>, <span>'series'</span>: <span>1</span>, <span>'Israeli'</span>: <span>1</span>, <span>'air-to-air'</span>: <span>1</span>, <span>'missiles'</span>: <span>1</span>, <span>'nuclear'</span>: <span>1</span>, <span>'primary,'</span>: <span>1</span>, <span>'gas-boosted'</span>: <span>1</span>, <span>'fission'</span>: <span>1</span>, <span>'primary'</span>: <span>1</span>, <span>'used'</span>: <span>1</span>, <span>'thermonuclear'</span>: <span>1</span>, <span>'weapons'</span>: <span>1</span>, <span>'Colt'</span>: <span>1</span>, <span>'revolver'</span>: <span>1</span>, <span>'uses[edit]'</span>: <span>1</span>, <span>'PYTHON,'</span>: <span>1</span>, <span>'British'</span>: <span>2</span>, <span>'nuclear'</span>: <span>1</span>, <span>'war'</span>: <span>1</span>, <span>'contingency'</span>: <span>1</span>, <span>'plan'</span>: <span>1</span>, <span>'film,'</span>: <span>1</span>, <span>'2000'</span>: <span>1</span>, <span>'horror'</span>: <span>1</span>, <span>'film'</span>: <span>1</span>, <span>'by'</span>: <span>3</span>, <span>'Richard'</span>: <span>1</span>, <span>'Clabaugh'</span>: <span>1</span>, <span>'mythology,'</span>: <span>1</span>, <span>'mythical'</span>: <span>1</span>, <span>'serpent'</span>: <span>1</span>, <span>'Monty'</span>: <span>1</span>, <span>'Pythons,'</span>: <span>1</span>, <span>'comedy'</span>: <span>1</span>, <span>'group'</span>: <span>1</span>, <span>'Monty'</span>: <span>1</span>, <span>'Pictures,'</span>: <span>1</span>, <span>'owned'</span>: <span>1</span>, <span>\"troupe's\"</span>: <span>1</span>, <span>'surviving'</span>: <span>1</span>, <span>'members'</span>: <span>1</span>, <span>'also[edit]'</span>: <span>1</span>, <span>'Cython,'</span>: <span>1</span>, <span>'programming'</span>: <span>1</span>, <span>'language'</span>: <span>1</span>, <span>'superset'</span>: <span>1</span>, <span>'Pyton,'</span>: <span>1</span>, <span>'Norwegian'</span>: <span>1</span>, <span>'magazine'</span>: <span>1</span>, <span>'Pithon'</span>: <span>1</span>, <span>'Disambiguation'</span>: <span>3</span>, <span>'page'</span>: <span>3</span>, <span>'providing'</span>: <span>1</span>, <span>'links'</span>: <span>3</span>, <span>'topics'</span>: <span>1</span>, <span>'that'</span>: <span>1</span>, <span>'could'</span>: <span>1</span>, <span>'be'</span>: <span>1</span>, <span>'referred'</span>: <span>1</span>, <span>'same'</span>: <span>1</span>, <span>'termThis'</span>: <span>1</span>, <span>'disambiguation'</span>: <span>5</span>, <span>'lists'</span>: <span>1</span>, <span>'articles'</span>: <span>1</span>, <span>'associated'</span>: <span>1</span>, <span>'with'</span>: <span>3</span>, <span>'title'</span>: <span>1</span>, <span>'Python.'</span>: <span>1</span>, <span>'If'</span>: <span>1</span>, <span>'link'</span>: <span>2</span>, <span>'led'</span>: <span>1</span>, <span>'you'</span>: <span>3</span>, <span>'here,'</span>: <span>1</span>, <span>'wish'</span>: <span>1</span>, <span>'change'</span>: <span>1</span>, <span>'point'</span>: <span>1</span>, <span>'directly'</span>: <span>1</span>, <span>'intended'</span>: <span>1</span>, <span>'article.'</span>: <span>1</span>, <span>'Retrieved'</span>: <span>1</span>, <span>'from'</span>: <span>2</span>, <span>'\"https://en.wikipedia.org/w/index.php?title=Python&#x26;oldid=983067155\"'</span>: <span>1</span>, <span>'Categories:'</span>: <span>1</span>, <span>'pagesHuman'</span>: <span>1</span>, <span>'pagesDisambiguation'</span>: <span>1</span>, <span>'pages'</span>: <span>3</span>, <span>'given-name-holder'</span>: <span>1</span>, <span>'listsHidden'</span>: <span>1</span>, <span>'categories:'</span>: <span>1</span>, <span>'short'</span>: <span>1</span>, <span>'descriptionsShort'</span>: <span>1</span>, <span>'description'</span>: <span>1</span>, <span>'is'</span>: <span>3</span>, <span>'different'</span>: <span>1</span>, <span>'WikidataAll'</span>: <span>1</span>, <span>'article'</span>: <span>1</span>, <span>'pagesAll'</span>: <span>1</span>, <span>'pagesAnimal'</span>: <span>1</span>, <span>'common'</span>: <span>1</span>, <span>'Navigation'</span>: <span>2</span>, <span>'menu'</span>: <span>1</span>, <span>'Personal'</span>: <span>1</span>, <span>'tools'</span>: <span>1</span>, <span>'Not'</span>: <span>1</span>, <span>'logged'</span>: <span>1</span>, <span>'inTalkContributionsCreate'</span>: <span>1</span>, <span>'accountLog'</span>: <span>1</span>, <span>'Namespaces'</span>: <span>1</span>, <span>'ArticleTalk'</span>: <span>1</span>, <span>'Variants'</span>: <span>1</span>, <span>'Views'</span>: <span>1</span>, <span>'ReadEditView'</span>: <span>1</span>, <span>'history'</span>: <span>1</span>, <span>'More'</span>: <span>1</span>, <span>'Search'</span>: <span>1</span>, <span>'Main'</span>: <span>1</span>, <span>'pageContentsCurrent'</span>: <span>1</span>, <span>'eventsRandom'</span>: <span>1</span>, <span>'articleAbout'</span>: <span>1</span>, <span>'WikipediaContact'</span>: <span>1</span>, <span>'usDonate'</span>: <span>1</span>, <span>'Contribute'</span>: <span>1</span>, <span>'HelpLearn'</span>: <span>1</span>, <span>'editCommunity'</span>: <span>1</span>, <span>'portalRecent'</span>: <span>1</span>, <span>'changesUpload'</span>: <span>2</span>, <span>'file'</span>: <span>1</span>, <span>'Tools'</span>: <span>1</span>, <span>'What'</span>: <span>1</span>, <span>'hereRelated'</span>: <span>1</span>, <span>'fileSpecial'</span>: <span>1</span>, <span>'pagesPermanent'</span>: <span>1</span>, <span>'linkPage'</span>: <span>1</span>, <span>'informationCite'</span>: <span>1</span>, <span>'this'</span>: <span>2</span>, <span>'pageWikidata'</span>: <span>1</span>, <span>'item'</span>: <span>1</span>, <span>'Print/export'</span>: <span>1</span>, <span>'Download'</span>: <span>1</span>, <span>'as'</span>: <span>1</span>, <span>'PDFPrintable'</span>: <span>1</span>, <span>'version'</span>: <span>1</span>, <span>'In'</span>: <span>1</span>, <span>'other'</span>: <span>1</span>, <span>'projects'</span>: <span>1</span>, <span>'Wikimedia'</span>: <span>2</span>, <span>'Commons'</span>: <span>2</span>, <span>'Languages'</span>: <span>1</span>, <span>'AfrikaansAlemannischالعربيةAzərbaycancaবাংলাБеларускаяБългарскиČeštinaDanskDeutschEsperantoEuskaraفارسیFrançais한국어HrvatskiIdoBahasa'</span>: <span>1</span>, <span>'IndonesiaInterlinguaÍslenskaItalianoעבריתქართულიKongoLatinaLëtzebuergeschMagyarमराठीNederlands日本語Norsk'</span>: <span>1</span>, <span>'bokmålPolskiPortuguêsРусскийSlovenčinaСрпски'</span>: <span>1</span>, <span>'/'</span>: <span>2</span>, <span>'srpskiSrpskohrvatski'</span>: <span>1</span>, <span>'српскохрватскиSuomiSvenskaไทยTürkçeУкраїнськаاردوTiếng'</span>: <span>1</span>, <span>'Việt中文'</span>: <span>1</span>, <span>'Edit'</span>: <span>1</span>, <span>'This'</span>: <span>1</span>, <span>'was'</span>: <span>1</span>, <span>'last'</span>: <span>1</span>, <span>'edited'</span>: <span>1</span>, <span>'on'</span>: <span>1</span>, <span>'12'</span>: <span>1</span>, <span>'October'</span>: <span>1</span>, <span>'2020,'</span>: <span>1</span>, <span>'at'</span>: <span>1</span>, <span>'01:39'</span>: <span>1</span>, <span>'UTC.'</span>: <span>1</span>, <span>'Text'</span>: <span>1</span>, <span>'available'</span>: <span>1</span>, <span>'under'</span>: <span>1</span>, <span>'Creative'</span>: <span>1</span>, <span>'Attribution-ShareAlike'</span>: <span>1</span>, <span>'License;'</span>: <span>1</span>, <span>'additional'</span>: <span>1</span>, <span>'terms'</span>: <span>1</span>, <span>'apply.'</span>: <span>1</span>, <span>'By'</span>: <span>1</span>, <span>'using'</span>: <span>1</span>, <span>'site,'</span>: <span>1</span>, <span>'agree'</span>: <span>1</span>, <span>'Terms'</span>: <span>1</span>, <span>'Use'</span>: <span>1</span>, <span>'Privacy'</span>: <span>2</span>, <span>'Policy.'</span>: <span>1</span>, <span>'Wikipedia®'</span>: <span>1</span>, <span>'registered'</span>: <span>1</span>, <span>'trademark'</span>: <span>1</span>, <span>'Foundation,'</span>: <span>1</span>, <span>'Inc.,'</span>: <span>1</span>, <span>'non-profit'</span>: <span>1</span>, <span>'organization.'</span>: <span>1</span>, <span>'policy'</span>: <span>1</span>, <span>'About'</span>: <span>1</span>, <span>'Disclaimers'</span>: <span>1</span>, <span>'Contact'</span>: <span>1</span>, <span>'Mobile'</span>: <span>1</span>, <span>'view'</span>: <span>1</span>, <span>'Developers'</span>: <span>1</span>, <span>'Statistics'</span>: <span>1</span>, <span>'Cookie'</span>: <span>1</span>, <span>'statement'</span>: <span>1</span>})</code></pre>\n<p>長いですがこのデータを使用します。</p>\n<h2>keyでソートする</h2>\n<p>それではキーでソートしていきます。</p>\n<p>ソート方法自体は、*sorted(ソート対象, key=ソートの基準, reverse=降順か昇順か)*で定義されるので、<em>key</em>の部分に<strong>lambda</strong>を採用してソートしていきます。コード自体は至って単純です。</p>\n<pre><code>sort = <span>sorted</span>(freq_word.items(), key=<span>lambda</span> x:x[<span>0</span>])</code></pre>\n<p>これだけで昇順で並べることができます。結果を確認すると、(<em>print(sort)</em>)</p>\n<p>多すぎるので上位20個だけ並べます。(<em>print(sort[:20])</em>)</p>\n<pre><code>[(<span>'\"https://en.wikipedia.org/w/index.php?title=Python&#x26;oldid=983067155\"'</span>, 1), (<span>'(1954–2014)'</span>, 1), (<span>'(4th-century'</span>, 1), (<span>'(Busch'</span>, 1), (<span>'(Coney'</span>, 1), (<span>'(Efteling),'</span>, 1), (<span>'(Ford'</span>, 1), (<span>'(Monty)'</span>, 1), (<span>'(UTC).'</span>, 1), (<span>'(automobile'</span>, 1), (<span>'(ca.'</span>, 1), (<span>'(film),'</span>, 1), (<span>'(genus),'</span>, 1), (<span>'(missile),'</span>, 1), (<span>'(mythology),'</span>, 1), (<span>'(nuclear'</span>, 1), (<span>'(painter),'</span>, 1), (<span>'(programming'</span>, 1), (<span>'-'</span>, 1), (<span>'/'</span>, 2)]</code></pre>\n<p>一応記号から始まっているものが先に来ています。記号をしっかり前処理で省いていれば良かったのでしょうが...</p>\n<p>それでもキーを元にソートすることができました!!</p>\n<p><strong>降順</strong>にする場合は、<em>reverse=True</em>を付け足すだけで昇順になります。</p>\n<pre><code>sort = <span>sorted</span>(freq_word.items(), key=<span>lambda</span> x:x[<span>0</span>], reverse=<span>True</span>)</code></pre>\n<pre><code>[(<span>'српскохрватскиSuomiSvenskaไทยTürkçeУкраїнськаاردوTiếng'</span>, 1), (<span>'you'</span>, 3), (<span>'workstation'</span>, 1), (<span>'with'</span>, 3), (<span>'wish'</span>, 1), (<span>'who'</span>, 1), (<span>'weapons'</span>, 1), (<span>'was'</span>, 1), (<span>'war'</span>, 1), (<span>'view'</span>, 1), (<span>'version'</span>, 1), (<span>'vase'</span>, 1), (<span>'using'</span>, 1), (<span>'uses[edit]'</span>, 1), (<span>'uses'</span>, 1), (<span>'used'</span>, 1), (<span>'usDonate'</span>, 1), (<span>'up'</span>, 1), (<span>'under'</span>, 1), (<span>\"troupe's\"</span>, 1)]</code></pre>\n<p>しっかりアルファベッドで降順になっていました。</p>\n<h2>valueでソートする</h2>\n<p>続いて<em>value</em>でソートしていきます。</p>\n<p>先ほどと同様に、ソート方法自体は、*sorted(ソート対象, key=ソートの基準, reverse=降順か昇順か)*で定義されるので、<em>key</em>の部分に<strong>lambda</strong>を採用してソートしていきます。コード自体は至って単純です。</p>\n<pre><code>sort = <span>sorted</span>(freq_word.items(), key=<span>lambda</span> x:x[<span>1</span>])</code></pre>\n<p>これだけで昇順で並べることができます。結果を確認すると、(<em>print(sort)</em>)</p>\n<p>多すぎるので上位20個だけ並べます。(<em>print(sort[:20])</em>)</p>\n<pre><code>[(<span>'-'</span>, 1), (<span>'From'</span>, 1), (<span>'Wikipedia,'</span>, 1), (<span>'encyclopedia'</span>, 1), (<span>'navigation'</span>, 1), (<span>'Look'</span>, 1), (<span>'up'</span>, 1), (<span>'python'</span>, 1), (<span>'Wiktionary,'</span>, 1), (<span>'dictionary.'</span>, 1), (<span>'refer'</span>, 1), (<span>'to:'</span>, 1), (<span>'Pythons'</span>, 1), (<span>'Pythonidae,'</span>, 1), (<span>'family'</span>, 1), (<span>'snakes'</span>, 1), (<span>'Africa,'</span>, 1), (<span>'Asia,'</span>, 1), (<span>'Australia'</span>, 1), (<span>'(genus),'</span>, 1)]</code></pre>\n<p>今回はデータが小さく、ほとんどが1なので正しくソートされているかはこれではわかりにくいですが、全体を出力すると正しいことがわかると思います。</p>\n<p>こちらもやはり<strong>降順</strong>にする場合は、<em>reverse=True</em>を付け足すだけで昇順になります。</p>\n<pre><code>sort = <span>sorted</span>(freq_word.items(), key=<span>lambda</span> x:x[<span>1</span>], reverse=<span>True</span>)</code></pre>\n<pre><code>[(<span>'Python'</span>, 23), (<span>'a'</span>, 19), (<span>'the'</span>, 15), (<span>'of'</span>, 12), (<span>'to'</span>, 9), (<span>'in'</span>, 7), (<span>'disambiguation'</span>, 5), (<span>'Wikipedia'</span>, 3), (<span>'or'</span>, 3), (<span>'may'</span>, 3), (<span>'and'</span>, 3), (<span>'Python,'</span>, 3), (<span>'name'</span>, 3), (<span>'roller'</span>, 3), (<span>'coaster'</span>, 3), (<span>'by'</span>, 3), (<span>'Disambiguation'</span>, 3), (<span>'page'</span>, 3), (<span>'links'</span>, 3), (<span>'with'</span>, 3)]</code></pre>\n<p>回数が多い順（降順）になっていますね。</p>\n<p>辞書型はこのように、<em>sorted(dict.items(), key=lambda x:x[0 or 1], reverse=True or False</em>でソートすることができました。</p>\n<p>辞書型のソートは意外と悩むことが個人的には多いので、備忘録がてら公開しておきます。</p>\n","Title":"Pythonで【辞書型】をソートする","Date":"2020-10-15","Category":"Python","Tags":"Python","Authors":"ゆうぼう","Slug":"py-sort-dict","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pyythonでソートをしたい時、初めの頃はあまり思いつかないことも多く、lambda式ってなんや...!?こんな状態でソートにはあまり手が出ず、コピペで戦っている方も多いのではないでしょうか。今回はその中でも「辞書型」のソートについてお話しします。","Published":true},{"contentHtml":"<p>ディープラーニングとか、とにかく複雑でメモリを使用するような計算処理が家庭用パソコンでもできる時代になりました。(そーゆー時代しか生きていないんですけど)とはいえ、メモリを意識せずともプログラムをかけているのは最適化されたライブラリを使っているからなわけで。。。そんなわけで自分でもメモリ管理を気をつけたいわけです。そこで、弱参照によって、うまいことPython処理系にメモリの破棄を促す方法をお話ししていきます。</p>\n<h2>Pyton処理系のお話</h2>\n<p>さて、これまでPythonを触ってきた僕ですが、メモリ管理を意識したことはほっとんどなく、大学の授業でC言語を学んだ際、低レイヤーの処理に少し不慣れで難しさを感じました。</p>\n<p>それくらいPython処理系はメモリ管理を強く意識させることはないということなのでしょう。</p>\n<p>それで、Python処理系は基本的には、<strong>オブジェクトが参照される回数をカウント</strong>して、参照するものがなくなった段階でメモリを破棄する。そんなイメージらしい。</p>\n<p>つまり、循環参照のような状態に陥ると、<strong>ユーザからは参照できないにもかかわらず、メモリに残ってしまう</strong>ということが発生するそうです。(他の手法でメモリが消されるのだろうが、こちらの消えて欲しいタイミングで消せることをメモリ管理と今回は考える)</p>\n<h2>メモリが即座に消されるパターン</h2>\n<p>以下が、参照カウント(あるオブジェクトを参照するものの数)によってきれいに即座にメモリが破棄されるパターンです。</p>\n<pre><code><span><span>class</span> <span>object</span>:</span>\n    <span>pass</span>\n    \n<span><span>def</span> <span>func</span>(<span>a</span>):</span>\n    <span>print</span>(a)\n    \na = <span>object</span>()  <span># a: 参照カウント 1</span>\nb = <span>object</span>()  <span># b: 参照カウント 1</span>\nc = <span>object</span>()  <span># c: 参照カウント 1</span>\n\na.b = b  <span># b: 参照カウント 2</span>\nb.c = c  <span># c: 参照カウント 2</span>\n\na = b = c = <span>None</span>  <span># メモリ破棄(a, b, c: 参照カウント 0)&#x3C;/code></span></code></pre>\n<h2>循環参照により即座に破棄されないパターン</h2>\n<p>続いて、循環参照を起こしてみます。これによって、長い間メモリに<strong>ユーザが参照できないオブジェクトが残ってしまいます</strong>。</p>\n<pre><code><span># ライブラリをインポート</span>\n<span>import</span> weakref\n\n<span><span>class</span> <span>object</span>:</span>\n    <span>pass</span>\n    \n<span><span>def</span> <span>func</span>(<span>a</span>):</span>\n    <span>print</span>(a)\n    \na = <span>object</span>()  <span># a: 参照カウント 1</span>\nb = <span>object</span>()  <span># b: 参照カウント 1</span>\nc = <span>object</span>()  <span># c: 参照カウント 1</span>\n\n<span># 以下を弱参照で循環させる</span>\na.b = b  <span># b: 参照カウント 2</span>\nb.c = c  <span># c: 参照カウント 2</span>\nc.a = a  <span># a: 参照カウント 2</span>\n<span># 以下でメモリが破棄されているか参照する</span>\na_ref = weakref.ref(a)\nb_ref = weakref.ref(b)\nc_ref = weakref.ref(c)\n\na = b = c = <span>None</span>  <span># メモリ破棄できない(a, b, c: 参照カウント 1)</span>\n\n<span>print</span>(a_ref, b_ref, c_ref)&#x3C;/code></code></pre>\n<p>出力はこんな感じです</p>\n<pre><code>&#x3C;weakref at 0x7fc5e3a49bf0; to <span>'object'</span> at 0x7fc5e3a40150> &#x3C;weakref at 0x7fc5e3a49c50; to <span>'object'</span> at 0x7fc5e3a40190> &#x3C;weakref at 0x7fc5e3a49cb0; to <span>'object'</span> at 0x7fc5e3a40250></code></pre>\n<p>破棄されていれば<em>dead</em>と書かれるはず...</p>\n<p>やはりダメですね。弱参照で破棄させましょう。</p>\n<h2>weakrefで改良</h2>\n<p>先ほどの問題を、<em>weakref.ref</em>を用いて、弱参照とすることで参照カウントを行わないように設定します。</p>\n<p>そうすることで参照カウントが最終的に0になり、メモリをPython処理系によって即座に破棄されることができます。</p>\n<pre><code><span># ライブラリをインポート</span>\n<span>import</span> weakref\n\n<span><span>class</span> <span>object</span>:</span>\n    <span>pass</span>\n    \n<span><span>def</span> <span>func</span>(<span>a</span>):</span>\n    <span>print</span>(a)\n    \na = <span>object</span>()  <span># a: 参照カウント 1</span>\nb = <span>object</span>()  <span># b: 参照カウント 1</span>\nc = <span>object</span>()  <span># c: 参照カウント 1</span>\n\n<span># 以下を弱参照で循環させる</span>\na.b = weakref.ref(b)  <span># b: 参照カウント 0</span>\nb.c = weakref.ref(c)  <span># c: 参照カウント 0</span>\nc.a = weakref.ref(a)  <span># a: 参照カウント 0</span>\n<span># 以下でメモリが破棄されているか参照</span>\na_ref = weakref.ref(a)\nb_ref = weakref.ref(b)\nc_ref = weakref.ref(c)\n\na = b = c = <span>None</span>  <span># メモリ破棄(a, b, c: 参照カウント 0)</span>\n\n<span>print</span>(a_ref, b_ref, c_ref)&#x3C;/code></code></pre>\n<p>出力がこんな感じ。</p>\n<pre><code>&#x3C;weakref at 0x7f868932dcb0; dead> &#x3C;weakref at 0x7f868932dbf0; dead> &#x3C;weakref at 0x7f868932dc50; dead></code></pre>\n<p>全て<em>dead</em>になっていますね。これで期待した通りのタイミングでメモリを破棄することができました!!!</p>\n<p>時には低いレイヤーまで考えてみるのも楽しいものですね。(時にはです。意識しなくていいことが幸せ)</p>\n","Title":"【weakref】弱い参照によってメモリ管理をする","Date":"2020-10-12","Category":"Python","Tags":"Python","Authors":"ゆうぼう","Slug":"weakref","THUMBNAIL":"python.jpg","Description":"ディープラーニングとか、とにかく複雑でメモリを使用するような計算処理が家庭用パソコンでもできる時代になりました。(そーゆー時代しか生きていないんですけど)とはいえ、メモリを意識せずともプログラムをかけているのは最適化されたライブラリを使っているからなわけで。。。そんなわけで自分でもメモリ管理を気をつけたいわけです。そこで、弱参照によって、うまいことPython処理系にメモリの破棄を促す方法をお話ししていきます。","Published":true},{"contentHtml":"<p>線形代数ライブラリを作ろうと色々とプログラムを書いていたわけですが、なんとなくで転置行列をどう簡単に求めるかということを考え始めました。その時に思いついた転置行列の求め方を共有します。</p>\n<h2>一般解ぽいやつ(個人の見解)</h2>\n<p>まずは一般に使われそうな方法を考えてみました。</p>\n<p>入力行列は<em>3x2</em>の行列として、求める転置行列は<em>2x3</em>とします。対応するインデックスの関係がわかりやすいように数値を設定してみます。</p>\n<pre><code>A = [\n    [<span>11</span>, <span>12</span>],\n    [<span>21</span>, <span>22</span>],\n    [<span>31</span>, <span>32</span>]\n]\n\nAt = []\nj = <span>0</span>\n<span>for</span> i <span>in</span> <span>range</span>(<span>len</span>(A[j])):\n    row = []\n    <span>for</span> j <span>in</span> <span>range</span>(<span>len</span>(A)):\n        row.append(A[j][i])\n    At.append(row)\n    \n<span>print</span>(At)</code></pre>\n<p>これで動くはず...オーソドックスか知らんけど、二重ループ回すのが一般的な思考だと思ったので、これを一般解として提示しました。</p>\n<p>ちなみに得られる出力はこちらです。</p>\n<pre><code>[[11, 21, 31], [12, 22, 32]]</code></pre>\n<p>多分大丈夫そう。</p>\n<h2>一般解ぽいやつを内包表記してみた</h2>\n<p>さきに示した一般解っぽいやつを内包表記を用いて書いてみます。</p>\n<pre><code>A = [\n    [<span>11</span>, <span>12</span>],\n    [<span>21</span>, <span>22</span>],\n    [<span>31</span>, <span>32</span>]\n]\n\nj = <span>0</span>\nAt = [\n    [A[j][i] <span>for</span> j <span>in</span> <span>range</span>(<span>len</span>(A))]\n        <span>for</span> i <span>in</span> <span>range</span>(<span>len</span>(A[j]))\n]\n<span>print</span>(At)</code></pre>\n<p>これも同様に同じ出力が得られます。</p>\n<pre><code>[[11, 21, 31], [12, 22, 32]]</code></pre>\n<h2>【本題】zipと展開の合わせ技</h2>\n<p>さて、本題です。僕が思いついた手法は以下になります。</p>\n<ol>\n<li>A(入力行列)を展開して、行列から列ごとに展開</li>\n<li>zip()を用いて統合</li>\n<li>内包表記にて転置行列を生成</li>\n</ol>\n<p>こんな流れになります。言葉で言っても難しいので、コードをみてみます。</p>\n<pre><code>A = [\n    [<span>11</span>, <span>12</span>],\n    [<span>21</span>, <span>22</span>],\n    [<span>31</span>, <span>32</span>]\n]\n\nAt = [\n    <span>list</span>(row) <span>for</span> row <span>in</span> <span>zip</span>(*A)\n]\n<span>print</span>(At)</code></pre>\n<p>これだけです。</p>\n<p>ただ、注意すべき点が一つだけあります。</p>\n<p>**list()**としているところです。それはなぜかというと、zipで統合された物は<em>tuple</em>で帰ってきます。</p>\n<p>内包表記において、listをとると次のような出力になります。</p>\n<pre><code>[(11, 21, 31), (12, 22, 32)]</code></pre>\n<p><em>tuple</em>で返ってきても良いスクリプトであればそのままでも良いと思いますが、<em>tuple</em>だとイミュータブルなデータになってしまうので、大抵の場合**list()**でlist型に直してあげた方が良いことが多い気がします。</p>\n<p>処理速度は測っていませんが、おそらく大きなサイズの行列の入力の時は高速に動くと思います(多分)</p>\n<p>興味ある人は処理速度を計測してみてください。それでは、簡単な転置行列を求める方法の提案でした。(Pythonに限る)</p>\n","Title":"簡単に転置行列求めてみた","Date":"2020-10-12","Category":"Python","Tags":"Python","Authors":"ゆうぼう","Slug":"py-trans-matrix","Thumbnail":"/images/thumbnails/python.jpg","Description":"線形代数ライブラリを作ろうと色々とプログラムを書いていたわけですが、なんとなくで転置行列をどう簡単に求めるかということを考え始めました。その時に思いついた転置行列の求め方を共有します。","Published":true},{"contentHtml":"<p>Pythonでクラスのインスタンスを生成して格納した変数を出力すると、class名とメモリ番地みたいなやつが出力されてしまいます。Pythonユーザーで機械学習とかで遊んでいる方はわかると思いますが、<em>numpy</em>はnp.ndarrayというクラスを持ちながら出力では行列が出力されます。線形代数計算ライブラリを自作している際、そのような特殊な出力にしたいことがありました。実際に行った方法をお話しします。</p>\n<p>正直タイトルにあるように、出落ちなのですが......</p>\n<p>*__str__*というPython独自の特殊メソッドを用いて、やりたいことを実現していきたいと思います。</p>\n<h2>やりたいこと</h2>\n<p>まずは、実際にやりたいことを明確にしていきます。<em>numpy</em>のような物を参考にしますが、今回は簡単のため、<em>Scalar</em>クラスを作ります。</p>\n<p>このクラスは、数値(intもしくはfloat)を受け取って、それを<em>data</em>として格納させます。</p>\n<p>求める最終形はこちらです。</p>\n<pre><code><span>>>> </span>scalar = Scalar(<span>5</span>)\n<span>>>> </span><span>print</span>(scalar)\nScalar(<span>5</span>)</code></pre>\n<p>本来であれば、*&#x3C;__main__.Scalar object at 0x7f85f3a00150>*のように表されてしまいますが、*Scalar(5)*というような特殊文字列にします。</p>\n<h2>Scalarクラスを作る</h2>\n<p>さて、これから<em>Scalar</em>クラスを作ります。</p>\n<p>初めは、最低限クラスとして機能するようなコードを書いていきます。</p>\n<p>Scalarクラスの仕様は以下とします。</p>\n<ul>\n<li>インスタンス生成時に<em>int</em>又は<em>float</em>を受け取る</li>\n<li>上の条件以外ならば、TypeErrorを発出</li>\n</ul>\n<p>これらの条件を満たすようにクラスを書いたのが以下になります。</p>\n<pre><code><span><span>class</span> <span>Scalar</span>:</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, data</span>):</span>\n        <span>if</span> <span>isinstance</span>(data, <span>int</span>) <span>or</span> <span>isinstance</span>(data, <span>float</span>):\n            self.data = data\n        <span>else</span>:\n            <span>raise</span> TypeError(<span>'expect int or float, but {}'</span>, <span>type</span>(data))</code></pre>\n<p>これでメインルーティンを書いていきます。</p>\n<p>以下を試してみます。</p>\n<ul>\n<li>intを入力</li>\n<li>floatを入力</li>\n<li>listを入力</li>\n</ul>\n<p>さて、書きたします。先ほどのクラスを書いたファイルを拡張していきます。</p>\n<pre><code><span><span>class</span> <span>Scalar</span>:</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, data</span>):</span>\n        <span>if</span> <span>isinstance</span>(data, <span>int</span>) <span>or</span> <span>isinstance</span>(data, <span>float</span>):\n            self.data = data\n        <span>else</span>:\n            <span>raise</span> TypeError(<span>'expect int or float, but {}'</span>, <span>type</span>(data))\n            \n<span>if</span> __name__ == <span>\"__main__\"</span>:\n    scalar = Scalar(<span>3</span>)\n    <span>print</span>(scalar)\n    scalar = Scalar(<span>3.0</span>)\n    <span>print</span>(scalar)\n    scalar = Scalar([<span>3</span>])\n    <span>print</span>(scalar)</code></pre>\n<p>ターミナルで実行してみます。</p>\n<pre><code>$ python scalar.py\n&#x3C;__main__.Scalar object at 0x7fddd4300150>\n&#x3C;__main__.Scalar object at 0x7fddd4300190>\nTraceback (most recent call last):\n  File <span>\"scalar.py\"</span>, line 13, <span>in</span> &#x3C;module>\n    scalar = Scalar([3])\n  File <span>\"scalar.py\"</span>, line 6, <span>in</span> __init__\n    raise TypeError(<span>'expect int or float, but {}'</span>, <span>type</span>(data))\nTypeError: (<span>'expect int or float, but {}'</span>, class <span>'list'</span>)</code></pre>\n<p>3と3.0の入力は受け取れましたが、どうやら[3]の入力は期待した通りエラーを出してくれています。</p>\n<p>しかし、やはりこのままではクラスをそのまま出力してしまっています。</p>\n<h2>【<strong>str</strong>】の出番</h2>\n<p>それでは、__str__という特殊メソッドを用いて、出力結果を変更していきます。</p>\n<p>先までのクラスを以下のように変えていきます。</p>\n<pre><code><span><span>class</span> <span>Scalar</span>:</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, data</span>):</span>\n        <span>if</span> <span>isinstance</span>(data, <span>int</span>) <span>or</span> <span>isinstance</span>(data, <span>float</span>):\n            self.data = data\n        <span>else</span>:\n            <span>raise</span> TypeError(<span>'expect int or float, but {}'</span>, <span>type</span>(data))\n            \n    &#x3C;span <span><span>class</span>=\"<span>comment</span>\"># 以下を追加\n    <span>def</span> <span>__str__</span>(<span>self</span>):</span>\n        <span>return</span> <span>'Scalar({})'</span>.<span>format</span>(self.data)</code></pre>\n<p>最後の2行を追加する感じです。</p>\n<p>それでは、<em>int</em>と<em>float</em>以外はエラーを出すことを確認しているのでメインルーティンも同時に変えて以下のファイルとして完成させましょう。</p>\n<pre><code><span><span>class</span> <span>Scalar</span>:</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, data</span>):</span>\n        <span>if</span> <span>isinstance</span>(data, <span>int</span>) <span>or</span> <span>isinstance</span>(data, <span>float</span>):\n            self.data = data\n        <span>else</span>:\n            <span>raise</span> TypeError(<span>'expect int or float, but {}'</span>, <span>type</span>(data))\n            \n    <span><span>def</span> <span>__str__</span>(<span>self</span>):</span>\n        <span>return</span> <span>'Scalar({})'</span>.<span>format</span>(self.data)\n        \n<span>if</span> __name__ == <span>\"__main__\"</span>:\n    scalar = Scalar(<span>3</span>)\n    <span>print</span>(scalar)\n    scalar = Scalar(<span>3.0</span>)\n    <span>print</span>(scalar)</code></pre>\n<p>この出力結果はどうなるでしょうか......(ドキドキ??)</p>\n<pre><code>$ python scalar.py\nScalar(3)\nScalar(3.0)</code></pre>\n<p>期待した通りの結果ですね!!</p>\n<p>このように、クラスのインスタンスの出力を制御するには**<strong>str</strong>**という特殊メソッドを使うと良いみたいです。</p>\n<p>ただし、<strong>__repr</strong>というものもあります。今回のソースに関しては正直いうと、この**<strong>repr</strong>**の方が適している気がします。(evalを使えば可逆的に戻すことができるため)</p>\n<p>詳しくはこちらを参照されたい(<a href=\"https://docs.python.org/ja/3/reference/datamodel.html\">https://docs.python.org/ja/3/reference/datamodel.html</a>)</p>\n<h2>今回のソースの推奨</h2>\n<pre><code><span><span>class</span> <span>Scalar</span>:</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, data</span>):</span>\n        <span>if</span> <span>isinstance</span>(data, <span>int</span>) <span>or</span> <span>isinstance</span>(data, <span>float</span>):\n            self.data = data\n        <span>else</span>:\n            <span>raise</span> TypeError(<span>'expect int or float, but {}'</span>, <span>type</span>(data))\n    <span><span>def</span> <span>__repr__</span>(<span>self</span>):</span>\n        <span>return</span> <span>'Scalar({})'</span>.<span>format</span>(self.data)\n        \n<span>if</span> __name__ == <span>\"__main__\"</span>:\n    scalar = Scalar(<span>3</span>)\n    <span>print</span>(scalar)\n    scalar = Scalar(<span>3.0</span>)\n    <span>print</span>(scalar)</code></pre>\n","Title":"classの標準出力を特殊な文字列にしたい【__str__|__repr__】","Date":"2020-10-12","Category":"Python","Tags":["Python","特殊メソッド","オブジェクト指向"],"Authors":"ゆうぼう","Slug":"py-class-repr","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pythonでクラスのインスタンスを生成して格納した変数を出力すると、class名とメモリ番地みたいなやつが出力されてしまいます。Pythonユーザーで機械学習とかで遊んでいる方はわかると思いますが、*numpy*はnp.ndarrayというクラスを持ちながら出力では行列が出力されます。線形代数計算ライブラリを自作している際、そのような特殊な出力にしたいことがありました。実際に行った方法をお話しします。","Published":true},{"contentHtml":"<p>Pythonからtkinterを使ってGUIを実装していました。Entryを使ってユーザの入力値を受け取ることができますが、デフォルト値の設定の仕方に困ったので、デフォルト値を設定した方法を共有します。</p>\n<h2>まずはEntryを生成</h2>\n<p>とりあえずコピペしたら動くようにします。</p>\n<p>ちなみに今回の僕の環境は以下になります。同じ環境で動かしたい場合は、以下のライブラリを<em>requirements.txt</em>にコピペでもして、インストールしてください。</p>\n<pre><code>altgraph==0.17\ncertifi==2020.6.20\nmacholib==1.14\nmysql-connector-python==8.0.21\nprotobuf==3.13.0\npyinstaller==4.0\npyinstaller-hooks-contrib==2020.9\nsix==1.15.0</code></pre>\n<pre><code>pip install -r  requirements.txt</code></pre>\n<p>上のやつをターミナルで回せばインストールできると思います。</p>\n<p>さて、本題。。。</p>\n<p>まずは、Entryを生成します。今回は、<em>entry.py</em>に書いていきます。</p>\n<p>一番大きなくくりのクラスを<em>App</em>として、このインスタンスをメインルーティンで立てていきます。</p>\n<pre><code><span>import</span> tkinter <span>as</span> tk\n\n<span><span>class</span> <span>App</span>(<span>tk.Tk</span>):</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, *args, **kwargs</span>):</span>\n        <span># 魔法</span>\n        tk.Tk.__init__(self, *args, **kwargs)\n\n        <span># 以下でタイトルとウィンドウサイズを設定</span>\n        self.title(<span>u\"tkinterでEntryにデフォルト値を入れたい\"</span>)\n        self.geometry(<span>\"500x300\"</span>)\n\n        <span># Frameを生成</span>\n        self.frame = tk.Frame()\n        self.frame.pack()\n        <span># Labelを生成</span>\n        label = tk.Label(self.frame, text=<span>'Your name'</span>)\n        label.pack()\n        <span># Entryを生成</span>\n        name = tk.Entry(self.frame)\n        name.pack()\n\n<span>if</span> __name__ == <span>\"__main__\"</span>:\n    app = App()\n    app.mainloop()</code></pre>\n<p>これでとりあえずエントリー(入力受付)が可能になります。ここでUIは一切凝っていないので、下のような状態になると思います。</p>\n<p><img src=\"/images/article/tk-entry-default_1.png\" alt=\"完成画面\"></p>\n<p>この入力受付に対して、「山田太郎」をデフォルト値として設定していきたいと思います。</p>\n<h2>デフォルト値の設定</h2>\n<p>続いて、「山田太郎」をデフォルト値として設定していきます。基盤は先ほどのコードになります。</p>\n<p>先に言うと、*tk.Entry().insert()*メソッドを用いて、エントリーに対して文字列を挿入します。</p>\n<p>それではコードを追加しましょう。</p>\n<pre><code><span>import</span> tkinter <span>as</span> tk\n\n<span><span>class</span> <span>App</span>(<span>tk.Tk</span>):</span>\n    <span><span>def</span> <span>__init__</span>(<span>self, *args, **kwargs</span>):</span>\n        <span># 魔法</span>\n        tk.Tk.__init__(self, *args, **kwargs)\n\n        <span># 以下でタイトルとウィンドウサイズを設定</span>\n        self.title(<span>u\"tkinterでEntryにデフォルト値を入れたい\"</span>)\n        self.geometry(<span>\"500x300\"</span>)\n\n        <span># Frameを生成</span>\n        self.frame = tk.Frame()\n        self.frame.pack()\n        <span># Labelを生成</span>\n        label = tk.Label(self.frame, text=<span>'Your name'</span>)\n        label.pack()\n        <span># Entryを生成</span>\n        name = tk.Entry(self.frame)\n\n        <span>\"\"\"ここにコードを1行追加\"\"\"</span>\n        name.insert(<span>0</span>, <span>\"山田太郎\"</span>)\n        <span>\"\"\"ここにコードを1行追加\"\"\"</span>\n\n        name.pack()\n\n<span>if</span> __name__ == <span>\"__main__\"</span>:\n    app = App()\n    app.mainloop()</code></pre>\n<p>概要は上記のようになります。</p>\n<p>後半部分に1行足しただけです。足したのはこれ。</p>\n<p><strong>name.insert(0, \"山田太郎\")</strong></p>\n<p>第一引数はインデックスを指していて、今回はエントリーの一番初めに挿入したいので、<em>0</em>を入れました。</p>\n<p>第二引数は実際に挿入したい値です。よって、今回は「<em>山田太郎</em>」を書きました。</p>\n<p>こうすることで結果は以下が得られると思います。</p>\n<p><img src=\"/images/article/tk-entry-default_2.png\" alt=\"挿入後完成画面\"></p>\n<p>これでデフォルト値の設定ができました。</p>\n<p>正攻法なのかは定かではないですが......www</p>\n<p>これでデフォルト値の設定ができました。必要な時は是非ご活用を。</p>\n","Title":"【Python】tkinterでEntryにデフォルト値を入れたい","Date":"2020-10-07","Category":"Python","Tags":["Python","Tkinter"],"Authors":"ゆうぼう","Slug":"tk-entry-default","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pythonからtkinterを使ってGUIを実装していました。Entryを使ってユーザの入力値を受け取ることができますが、デフォルト値の設定の仕方に困ったので、デフォルト値を設定した方法を共有します。","Published":true},{"contentHtml":"<p>時々、Seleniumで要素を取得してクリックした際、うまくいかないことがあります。その時いくつかの解決策があるのですが、今回はJavaScriptを発火させて解決する方法を解説していきます。。</p>\n<p>それでは早速やってみます。</p>\n<p>前提条件は以下になります。</p>\n<ul>\n<li>Python環境が整っている</li>\n<li>Seleniumをインストール済み</li>\n<li>chromedriverをインストール済み</li>\n</ul>\n<h2>SeleniumからJavascriptを発火する</h2>\n<p>JavaScriptを発火させることはとても簡単です。</p>\n<pre><code><span>from</span> selenium <span>import</span> webdriver\n<span>import</span> chromedriver_binary\n\ndriver = webdriver.Chrome()\ndriver.get(<span>'https://www.example.com/'</span>)\ndriver.execute_script(<span>'Your Procedure'</span>)</code></pre>\n<p>まずは、Webdriverを開き、その後<em>execute_script</em>メソッドを用いて、引数にJSのスクリプトを書き込むのみです。</p>\n<h2>実際にボタンをクリックしてみる!</h2>\n<p>実際にJSのスクリプトと合わせて、<em>#button</em>を持つ要素をクリックしてみましょう。</p>\n<pre><code><span>from</span> selenium <span>import</span> webdriver\n<span>import</span> chromedriver_binary\n\ndriver = webdriver.Chrome()\ndriver.get(<span>'https://www.example.com/'</span>)\ndriver.execute_script(<span>'document.getElementById(\"button\").click();'</span>)</code></pre>\n<p>スクリプト全体の流れは以下になります。</p>\n<ol>\n<li>必要なモジュールをインポート</li>\n<li>webdriver立ち上げる</li>\n<li>対象のサイトを開く</li>\n<li><em>execute_script</em>でJSを発火</li>\n</ol>\n<p>上記のスクリプトはこの流れになります。</p>\n<p>時々、ポップアップとかトレース型広告とかでクリックできない場面があります。\nその際はJSから直押ししてあげるとうまく行くことがあります。</p>\n<p>この方法で解決できない場面も多いですが、比較的容易な手法なので頭の中に一つの解決策として留めておくのもありだと思います。</p>\n","Title":"Seleniumからクリックができない...そうだ、JSからクリックしよう","Date":"2020-09-26","Category":"Python","Tags":["Python","Selenium"],"Authors":"ゆうぼう","Slug":"selenium-click-by-js","Thumbnail":"/images/thumbnails/python.jpg","Description":"時々、Seleniumで要素を取得してクリックした際、うまくいかないことがあります。その時いくつかの解決策があるのですが、今回はJavaScriptを発火させて解決する方法を解説していきます。","Published":true},{"contentHtml":"<p>データ収集中にint型に文字列をパースすることがあったのですが、みるからに数値なのにエラーが返ってきました。これは何気にドツボでした。</p>\n<h2>ValueErrorの発生</h2>\n<p>エラーを招いたコードの例がこちら</p>\n<pre><code>a = np.array([<span>'1.0'</span>, <span>'2.0'</span>]).astype(<span>'int16'</span>)</code></pre>\n<p>実際に出たエラーがこちらです。</p>\n<pre><code>ValueError: invalid literal <span>for</span> int() with base 10:</code></pre>\n<p>エラー読んでもいまいち理解できませんでした。</p>\n<p>正しくないリテラル...どういうこっちゃ!?</p>\n<h2>【原因】文字列が小数だった</h2>\n<p>原因は意外にもシンプルで、文字列の形が<strong>小数</strong>だったからみたいです...</p>\n<p>他のコードで確認してみると</p>\n<pre><code>a = np.array([<span>'1'</span>, <span>'2'</span>]).astype(<span>'int16'</span>)\n\n<span># >> array([1, 2], dtype=int16</span></code></pre>\n<pre><code>a = np.array([<span>'1.0'</span>, <span>'2.0'</span>]).astype(<span>'float32'</span>)\n\n<span># >> array([1, 2], dtype=float32)</span></code></pre>\n<p>小数であった時、floatへの変換はうまくいっているようです。</p>\n<h2>改善策</h2>\n<p>いったんfloatに変換してから、intに変換するとできます。遠回りですが。</p>\n<pre><code>a = np.array([<span>'1.0'</span>, <span>'2.0'</span>]).astype(<span>'float32'</span>).astype(<span>'int16'</span>)\n\n<span># >> array([1, 2], dtype=int16)</span></code></pre>\n<p>このようなエラーに直面したら、<strong>配列の中身の文字列が少数になっていないか</strong>確認してみましょう!!</p>\n","Title":"invalid literal for int() with base 10: でint型のパースでエラーが！ ","Date":"2020-09-11","Category":"Python","Tags":"Python","Authors":"ゆうぼう","Slug":"parse-int-base10","Thumbnail":"/images/thumbnails/python.jpg","Description":"データ収集中にint型に文字列をパースすることがあったのですが、みるからに数値なのにエラーが返ってきました。これは何気にドツボでした。","Published":true},{"contentHtml":"<p>Macは普段使いなので、あまり情報収集に使いたくなかったために、常時Windowsのノートパソコンを情報収集ボットとしようとしました。</p>\n<p>その時コードの共有をDropboxを用いたのですが、なぜかいくらpandasを入れても<br>\n<em>\"No module named 'pandas.core.internals.managers'; 'pandas.core.internals' is not a package\"</em><br>\nというエラーが...</p>\n<p>その原因がわかったのでそのお話をします。</p>\n<h2>\"No module\"エラーの発生!?</h2>\n<p>前述したとおり、環境の違う状態でコードを共有したわけです。</p>\n<p>確認してみると、やはりpandasのバージョンが違っていました。他の記事でも採算を話をしていますが、機械学習によく使われるライブラリたちは特段アップデートが早く、さらに大幅な変更も多い印象です。</p>\n<p>実際に起こった原因は、<strong>pickleに入れたpandasとロード先のpandasのバージョンの違い</strong>でした。</p>\n<p>実際の僕のバージョンは以下でした。</p>\n<table>\n<thead>\n<tr>\n<th>対象</th>\n<th>pandasのバージョン</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>以前のpandas</td>\n<td>0.24.2</td>\n</tr>\n<tr>\n<td>移植先のpandas</td>\n<td>0.23.1</td>\n</tr>\n</tbody>\n</table>\n<p>そのバージョンが違うと次のようなエラーが出ることがあります。</p>\n<pre><code><span>\"No module named 'pandas.core.internals.managers'; 'pandas.core.internals' is not a package\"</span></code></pre>\n<p>上のようなモジュールがないよ！！</p>\n<p>と怒られるわけです。</p>\n<p>なので、次の解決策を示します</p>\n<ul>\n<li>再度データを作り直す</li>\n<li>前の環境を調べてinstallし直す</li>\n<li>前の環境にrequirements.txtを作成しておいて同じ環境を立てる</li>\n</ul>\n<p>次のセクションでお話をします。</p>\n<h2>再度データを作り直す</h2>\n<p>このやり方はいうまでもないですが、もう一度作り直す方法です。</p>\n<p>前の環境がわからないなど、どうしようもない時はこの方法で太刀打ちすれば良いかと思います</p>\n<pre><code><span>import</span> pandas <span>as</span> pd\n<span>import</span> pickle\n\ndf = pd.DataFrame()\n<span>with</span> <span>open</span>(<span>'sample.pickle'</span>, <span>'wb'</span>) <span>as</span> f:\n    pickle.load(df, f)</code></pre>\n<p>といったように、現状の環境で作り直す方法です。</p>\n<h2>前の環境を調べてinstallし直す</h2>\n<p>前の環境でのバージョンが分かっていれば入れ直せば良いでしょう。</p>\n<pre><code>$ pip install pandas==<span>'your pandas version'</span></code></pre>\n<p>これで特定のバージョンのpandasを入手できるはずです。</p>\n<h2>前の環境にrequirements.txtを作成しておいて同じ環境を立てる</h2>\n<p>前の環境が目の前にあるならば、以下のようにして<em>requirements.txt</em>を作成してしまえば早いでしょう。</p>\n<pre><code>$ pip freeze > requirements.txt</code></pre>\n<pre><code><span># 新しい環境にて</span>\n$ pip install -r requirements.txt</code></pre>\n<p>これで以前と同じ環境が整うので、心配なく動くと思います。</p>\n","Title":"pickleでロードした時pandasがあるのに\"No module ~~\"で悩んだ件について","Date":"2020-09-10","Category":"Python","Tags":["Python","Pandas"],"Authors":"ゆうぼう","Slug":"pandas-nomodule","Thumbnail":"/images/thumbnails/python.jpg","Description":"Macは普段使いなので、あまり情報収集に使いたくなかったために、常時Windowsのノートパソコンを情報収集ボットとしようとしました。その時コードの共有をDropboxを用いたのですが、なぜかいくらpandasを入れても\"No module named 'pandas.core.internals.managers'; 'pandas.core.internals' is not a package\"というエラーが。。。その原因がわかったのでそのお話をします。","Published":true},{"contentHtml":"<p>他のディレクトリで作ったモジュールの<em>import</em>をさせたかったのですが、その方法がイマイチわからなくて詰まりました。</p>\n<p>下の階層にあるなら\"<em>.</em>\"でつなげばいいのですが、階層を遡る必要があると困ったので解決策を提示します。</p>\n<p>今回は下層にあるとして進めます。階層が深くなると.(ドット)による記述が無駄に長くなるので、ある程度この記述で冗長な記述も避けられるかな？？と思ったからです。</p>\n<h2>やりたかったこと</h2>\n<p>他のディレクトリ内のモジュールを引っ張ってくる。</p>\n<p>階層構造は以下のようにしてみる</p>\n<pre><code>--- target\n    |      |\n    |      |--- sample.py\n    |\n    |--- main.py  &#x3C;-- 今ここ</code></pre>\n<p>で、直感的にやりたかったのがこれ</p>\n<pre><code><span>@ main.py</span>\n<span>from</span> target.sample <span>import</span> Sample</code></pre>\n<p>これはできるんだけど、もし<br>\n<em>from target.target1.target2.sample import Sample</em><br>\nとかだったらすごく萎えるよね...</p>\n<h2>【 解決策 】Pathにセットしてあげる</h2>\n<p><strong>sysとosを使って解決します!!</strong></p>\n<p>先ほどの階層構造に則ると、参照して欲しいディレクトリはtargetですね。</p>\n<p>先に手順を話すと以下になります。</p>\n<ol>\n<li>sysとosのimport</li>\n<li>os.getcwd()でカレントディレクトリを取得(今回は同じ階層のディレクトリにつながっているため)</li>\n<li>sys.path.append()でPathを追加</li>\n</ol>\n<p>この手順にのっとって書いてみます</p>\n<pre><code><span># 手順1</span>\n<span>import</span> sys\n<span>import</span> os\n\n<span># 手順2 &#x26; 3</span>\nsys.path.append(os.getcwd() + <span>'target'</span>)\n<span>from</span> sample <span>import</span> Sample</code></pre>\n<p>一応これで対応できました。</p>\n<p>もし仮に4層、5層...と続いてもpathをセットしておけば、探してくれるので大丈夫です。</p>\n<p>階層を遡るときは、その都度pathにいれるパスを変えてみてください!!</p>\n","Title":"自作のモジュールを他のディレクトリから持ってきたい!!","Date":"2020-09-03","Category":"Python","Tags":"Python","Authors":"ゆうぼう","Slug":"python-add-path","Thumbnail":"/images/thumbnails/python.jpg","Description":"機械学習の学習中に、他のディレクトリで作った自作関数が使いたかったのだけど、うまくimportする方法に悩みました。pythonがモジュールを探すpathをセットしてあげるだけで済んだので、その方法を解説します。","Published":true},{"contentHtml":"<p>Pythonで始める機械学習でお勉強中にFutureWarningに遭遇しました。GroupKFoldで起こったのですが、とりあえず今は使えるもののこの先使えなくなることが示されているので修正します。</p>\n<h2>FutureWarningを発生させてみる</h2>\n<p>少し前の書籍の型に合わせてコードを書いてみます。<del>FutureWarning</del>が発生するはずです。</p>\n<pre><code><span>@python</span>\n\n<span>from</span> sklearn.model_selection <span>import</span> GroupKFold  <span># グループ交差検証</span>\n<span>from</span> sklearn.datasets <span>import</span> make_blobs  <span># 合成データ生成</span>\n\n<span># 合成データセットを生成</span>\nX, y = make_blobs(n_samples=<span>10</span>, random_state=<span>0</span>)\n<span># 最初の2サンプルが同じグループに、次の4つが同じグループに</span>\ngroups = [<span>0</span>, <span>0</span>, <span>1</span>, <span>1</span>, <span>1</span>, <span>1</span>, <span>3</span>, <span>3</span>, <span>4</span>, <span>4</span>]\nscores = cross_val_score(logreg, X, y, groups, cv=GroupKFold(n_splits=<span>3</span>))\n<span>print</span>(<span>\"Cross-validation scores:\\n{}\"</span>.<span>format</span>(scores))</code></pre>\n<p>おそらくこの型が少し前の技術書の仕様だと思います。<em>Pythonで始める機械学習</em>もこの型でした。</p>\n<p>結果をみてみます。</p>\n<pre><code>Cross-validation scores:\n[0.5 1.  1. ]\n/Users/user/opt/anaconda3/envs/ML/lib/python3.6/site-packages/sklearn/utils/validation.py:71: \nFutureWarning: Pass groups=[0, 0, 1, 1, 1, 1, 3, 3, 4, 4] as keyword args. \nFrom version 0.25 passing these as positional arguments will result <span>in</span> an error\nFutureWarning)</code></pre>\n<p>こんな感じのWarningが発生します。</p>\n<p>最後の方を読んでみると、<strong>バージョン0.25からはgroups配列は位置引数としてだとエラーになるよ</strong>みたいな感じのことを言っています。改善方法は至ってシンプルです。<br>\n次に示します。</p>\n<h2>改善策</h2>\n<p>改善策は至ってシンプルです。</p>\n<p>**groups=(グループ配列)**にすればいいのです。直したコードを示します。</p>\n<pre><code><span>@python</span>\n\n<span>from</span> sklearn.model_selection <span>import</span> GroupKFold  <span># グループ交差検証</span>\n<span>from</span> sklearn.datasets <span>import</span> make_blobs  <span># 合成データ生成</span>\n\n<span># 合成データセットを生成</span>\nX, y = make_blobs(n_samples=<span>10</span>, random_state=<span>0</span>)\n<span># 最初の2サンプルが同じグループに、次の4つが同じグループに</span>\ngroups = [<span>0</span>, <span>0</span>, <span>1</span>, <span>1</span>, <span>1</span>, <span>1</span>, <span>3</span>, <span>3</span>, <span>4</span>, <span>4</span>]\nscores = cross_val_score(logreg, X, y, groups=groups, cv=GroupKFold(n_splits=<span>3</span>))\n<span>print</span>(<span>\"Cross-validation scores:\\n{}\"</span>.<span>format</span>(scores))</code></pre>\n<p>直したのはこの部分</p>\n<pre><code>scores = cross_val_score(logreg, X, y, groups=groups, cv=GroupKFold(n_splits=<span>3</span>))</code></pre>\n<p>単に<em>groups=groups</em>にするだけです。これだけで直ります。</p>\n<p>やはりFutureWarningが多いですね〜この周りは。</p>\n","Title":"Scikit-learnのGroupKFoldでgroups配列でWarning発生!!","Date":"2020-08-18","Category":"Python","Tags":["Scikit-learn","Python"],"Authors":"ゆうぼう","Slug":"groupfold-groups","Thumbnail":"/images/thumbnails/network.jpg","Description":"Pythonで始める機械学習でお勉強中にFutureWarningに遭遇しました。GroupKFoldで起こったのですが、とりあえず今は使えるもののこの先使えなくなることが示されているので修正します。","Published":true},{"contentHtml":"<p>MeCabを利用したWebアプリケーションをHerokuにデプロイしようとして、環境をrequirements.txtにまとめていたのですが、、、どうしてもエラーが出てインストールが止まってしまうことがありました。原因は、Mecabだったようなので、エラー回避方法を共有します。</p>\n<p>前提条件として、</p>\n<ul>\n<li>mecabを<em>pip mecab</em>でインストール済み</li>\n<li>HerokuをCLIでいじる準備ができている</li>\n</ul>\n<h2>とりあえずrequirements.txtを作成</h2>\n<p>まあ、pip listしてまず現環境におけるライブラリをみていきましょう。</p>\n<p>例えばこんな構成だとします。</p>\n<pre><code>(myvenv)$ ~ pip list\nPackage                Version\n---------------------- -------------------\ncertifi                2020.6.20\nchardet                3.0.4\nclick                  7.1.2\nFlask                  1.1.2\ngunicorn               20.0.4\nidna                   2.10\nitsdangerous           1.1.0\nJinja2                 2.11.2\nMarkupSafe             1.1.1\nmecab                  0.996.2\nmysql-connector-python 8.0.21\noauthlib               3.1.0\npip                    20.1.1\nprotobuf               3.12.4\nrequests               2.24.0\nrequests-oauthlib      1.3.0\nsetuptools             49.2.0.post20200714\nsix                    1.15.0\nurllib3                1.25.10\nWerkzeug               1.0.1\nwheel                  0.34.2</code></pre>\n<p>中段くらいにmecabのバージョン0.996.2がありますね。それではこれをもとに、requirements.txtを作成していきます。</p>\n<pre><code>(myvenv)$ ~ pip freeze > requirements.txt</code></pre>\n<p>これで下準備OKです</p>\n<h2>Herokuへログインしてデプロイ</h2>\n<p>それではコマンドラインを開きまして、デプロイしていきましょう。</p>\n<pre><code>$ ~ heroku % login</code></pre>\n<p>これを打つと、認証画面的にブラウザが勝手に開きます。それでログインできていれば、この画面を消してターミナルに戻る旨の内容が書かれています。</p>\n<p>それで、成功したとして、次は</p>\n<pre><code>$ ~ % heroku git:<span>clone</span> -a your-app-name\n$ ~ % <span>cd</span> your-app-directory\n\n$ your-app-directory % git add .\n$ your-app-directorygit % commit -am <span>\"deploy!!\"</span>\n$ your-app-directorygit % push heroku master</code></pre>\n<p>こうするとPythonの場合、<strong>runtime.txt</strong>からPythonのバージョンを、<strong>requirements.txt</strong>から依存ライブラリのパッケージを確認して、インストールしていくと次のような問題が発生します。</p>\n<pre><code>-----> Python app detected\n-----> Installing python-3.8.5\n-----> Installing pip 20.0.2, setuptools 39.0.1 and wheel 0.34.2\n-----> Installing SQLite3\n-----> Installing requirements with pip\n    Collecting certifi==2020.6.20\n        Downloading certifi-2020.6.20-py2.py3-none-any.whl (156 kB)\n    Collecting chardet==3.0.4\n            ( 中略 )\n    Collecting mecab==0.996.2\n        Downloading mecab-0.996.2.tar.gz (62 kB)\n        ERROR: Command errored out with <span>exit</span> status 1:\n            <span>command</span>: /app/.heroku/python/bin/python -c <span>'import sys, setuptools, tokenize; sys.argv[0] = '</span><span>\"'\"</span><span>'/tmp/pip-install-kr1kq54r/\n            mecab/setup.py'</span><span>\"'\"</span><span>'; __file__='</span><span>\"'\"</span><span>'/tmp/pip-install-kr1kq54r/mecab/setup.py'</span><span>\"'\"</span><span>';f=getattr(tokenize, '</span><span>\"'\"</span><span>'open'</span><span>\"'\"</span><span>', open)\n            (__file__);code=f.read().replace('</span><span>\"'\"</span><span>'\\r\\n'</span><span>\"'\"</span><span>', '</span><span>\"'\"</span><span>'\\n'</span><span>\"'\"</span><span>');f.close();exec(compile(code, __file__, '</span><span>\"'\"</span><span>'exec'</span><span>\"'\"</span><span>'))'</span> \n            egg_info --egg-base /tmp/pip-install-kr1kq54r/mecab/pip-egg-info\n                cwd: /tmp/pip-install-kr1kq54r/mecab/\n        Complete output (10 lines):\n        /bin/sh: 1: mecab-config: not found\n        Traceback (most recent call last):\n            File <span>\"&#x3C;string>\"</span>, line 1, <span>in</span> &#x3C;module>\n            File <span>\"/tmp/pip-install-kr1kq54r/mecab/setup.py\"</span>, line 53, <span>in</span> &#x3C;module>\n            include_dirs=cmd2(<span>\"mecab-config --inc-dir\"</span>),\n            File <span>\"/tmp/pip-install-kr1kq54r/mecab/setup.py\"</span>, line 19, <span>in</span> cmd2\n            <span>return</span> cmd1(strings).split()\n            File <span>\"/tmp/pip-install-kr1kq54r/mecab/setup.py\"</span>, line 15, <span>in</span> cmd1\n            <span>return</span> os.popen(strings).readlines()[0].rstrip()\n        IndexError: list index out of range\n        ----------------------------------------\n    ERROR: Command errored out with <span>exit</span> status 1: python setup.py egg_info Check the logs <span>for</span> full <span>command</span> output.\n    !     Push rejected, failed to compile Python app.\n    !     Push failed</code></pre>\n<p>こんな感じに怒られるわけですよ...orz</p>\n<h2>悪さをするのはMecabだった！？</h2>\n<p>どうやら悪さをしていたのは、<strong>MeCab</strong>だったようです。再度requirements.txtの一部を確認します。</p>\n<pre><code>requirements.txt   |\n----------------------------\ncertifi==2020.6.20\nchardet==3.0.4\nclick==7.1.2\nFlask==1.1.2\ngunicorn==20.0.4\nidna==2.10\nitsdangerous==1.1.0\nJinja2==2.11.2\nMarkupSafe==1.1.1\nmecab==0.996.2\n..................</code></pre>\n<p>どうやら調べてみると、このmecabで指定しているのがよくないみたいですね...</p>\n<p>というわけで、この<strong>mecab==0.996.2</strong>というのをどかしてやりますね。どうするかと言いますと、<br>\n<strong>mecab-python</strong>に変えてあげます。特にバージョンは指定しなくてもよかったです。</p>\n<p>ということで直します。</p>\n<pre><code>requirements.txt   |\n----------------------------\n..................\n..................\nmecab-python       <span># mecab==0.996.2 を修正</span>\n..................</code></pre>\n<p>これでうまくいくはずです！！</p>\n<p>もしうまくいかなかったら、打ち損じとか全角になってないか、他のライブラリでのエラー等を疑うといいと思います。</p>\n<p>これぬまにハマりそうなので、同じエラーに悩む人がいたら是非参考にしてください。</p>\n","Title":"HerokuにMecCabインストールで困った!!","Date":"2020-08-05","Category":"Python","Tags":["Python","MeCab"],"Authors":"ゆうぼう","Slug":"heroku-mecab","Description":"MeCabを利用したWebアプリケーションをHerokuにデプロイしようとして、環境をrequirements.txtにまとめていたのですが、、、どうしてもエラーが出てインストールが止まってしまうことがありました。原因は、Mecabだったようなので、エラー回避方法を共有します。","Published":true},{"contentHtml":"<p>ロジスティック回帰をscikit-learnで実装していると、デフォルトはL2正則化でペナルティを与えています。</p>\n<p>そこで、もっとスパースにしてやろうとL1正則化を行おうとしたのだが、エラーを吐かれた。その時の解決策を共有します。</p>\n<h2>エラーを吐かれた時のバージョン</h2>\n<p>一応最近開発が立て込んでいるので、Anacondaを使って開発環境を分けているのですが、</p>\n<pre><code>(base)$ conda activate ML\n(ML)$ conda list    (pip listでも行ける)\n......\n......\nscikit-learn           0.23.1    \n......</code></pre>\n<p>ということで、scikit-learnのバージョンは<em>0.23.1</em>でした。</p>\n<h2>実装してみる</h2>\n<p>それでは実装してみます。至ってシンプルなスクリプトで動く想定でやっていきます。こちらで変化させるハイパーパラメータは以下になります。</p>\n<table>\n<thead>\n<tr>\n<th>パラメータ</th>\n<th>値</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>C(正則化のつよさ)</td>\n<td>1(デフォルト)</td>\n</tr>\n<tr>\n<td>penalty</td>\n<td>L1正則化</td>\n</tr>\n<tr>\n<td>max_iter(イテレーションの上限)</td>\n<td>100000</td>\n</tr>\n</tbody>\n</table>\n<p>また、訓練データ(X_train, y_train)とテストデータ(X_test, y_test)に分けてあることにします。</p>\n<pre><code><span>from</span> sklearn.linear_model <span>import</span> LogisticRegression\n\nlr_l1 = LogisticRegression(penalty=<span>'l1'</span>, max_iter=<span>100000</span>).fit(X_train, y_train)</code></pre>\n<p>するとこんなエラーが返ってきます。</p>\n<pre><code>~/opt/anaconda3/envs/ML/lib/python3.6/site-packages/sklearn/linear_model/_logistic.py <span>in</span> fit(self, X, y, sample_weight)\n1302         The SAGA solver supports both float64 and float32 bit arrays.\n1303         <span>\"\"</span><span>\"\n-> 1304         solver = _check_solver(self.solver, self.penalty, self.dual)\n1305 \n1306         if not isinstance(self.C, numbers.Number) or self.C &#x3C; 0:\n\n~/opt/anaconda3/envs/ML/lib/python3.6/site-packages/sklearn/linear_model/_logistic.py in _check_solver(solver, penalty, dual)\n441     if solver not in ['liblinear', 'saga'] and penalty not in ('l2', 'none'):\n442         raise ValueError(\"</span>Solver %s supports only <span>'l2'</span> or <span>'none'</span> penalties, <span>\"\n--> 443                          \"</span>got %s penalty.<span>\" % (solver, penalty))\n444     if solver != 'liblinear' and dual:\n445         raise ValueError(\"</span>Solver %s supports only <span>\"\n\nValueError: Solver lbfgs supports only 'l2' or 'none' penalties, got l1 penalty.</span></code></pre>\n<p>ファイルのありかは人それぞれですが、エラーは返ってきます。<br>\nデフォルトの<strong>Solverがlbfgs</strong>に変わっていたそうで、l2またはnoneしかペナルティをサポートしていないそうです。</p>\n<p>というわけで、Solverに<strong>liblinear</strong>を指定しないといけないようですね。</p>\n<h2>liblinearを指定する</h2>\n<p>先ほどのエラーをなくすため、新たにパラメータを足します。</p>\n<table>\n<thead>\n<tr>\n<th>パラメータ</th>\n<th>値</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>C(正則化のつよさ)</td>\n<td>1(デフォルト)</td>\n</tr>\n<tr>\n<td>penalty</td>\n<td>L1正則化</td>\n</tr>\n<tr>\n<td>max_iter(イテレーションの上限)</td>\n<td>100000</td>\n</tr>\n<tr>\n<td>solver</td>\n<td>liblinear</td>\n</tr>\n</tbody>\n</table>\n<p>では足します。</p>\n<pre><code><span>from</span> sklearn.linear_model <span>import</span> LogisticRegression\n\nlr_l1 = LogisticRegression(penalty=<span>'l1'</span>, solver=<span>'liblinear'</span>, max_iter=<span>100000</span>).fit(X_train, y_train)</code></pre>\n<p>これで無事動くようになりました!!!</p>\n<h2>まとめ</h2>\n<p>まとめです。<br>\nscikit-learnを用いて、ロジスティック回帰を使う時、さらにL1正則化をかけたい時は**solver='liblinear'**を引数に追加しましょう。</p>\n<p>この周りは色々と変化が早いので、本を買う際にも初版等も確認しつつ買った方が良い気がしました。バージョン確認も大切に。</p>\n","Title":"ロジスティック回帰でL1正則化を利用できない問題の解決法","Date":"2020-08-01","Category":"Python","Tags":["ML","Python","Scikit-learn"],"Authors":"ゆうぼう","Slug":"logistic-with-l1","Thumbnail":"/images/thumbnails/network.jpg","Description":"ロジスティック回帰をscikit-learnで実装していると、デフォルトはL2正則化でペナルティを与えています。そこで、もっとスパースにしてやろうとL1正則化を行おうとしたのだが、エラーを吐かれた。その時の解決策を共有します。","Published":true},{"contentHtml":"<p>一応参考書通りに学習するのだが、基本的にはいつも最新版をインストールして使う人間なもので、Warning及びErrorとの戦いはよくあることです。ので、Warningとかが出るとうっと身構えてしまうので、困らないように備忘録かつ反面教師として残しておきます。</p>\n<h2>とりあえずmake_forge()をやってみようか</h2>\n<p>とりあえずmake_forge()でforgeデータを生成し、Warningさせてみますかね。。。</p>\n<p>ライブラリはmglearnを使うのでpip環境がある人は、<strong>pip install mglearn</strong>をしてください。その上で、</p>\n<pre><code><span>import</span> mglearn    <span># mglearnのインポート</span>\nX, y = mglearn.datasets.make_forge()    <span># make_forgeメソッドで生成</span></code></pre>\n<p>以下がアウトプットです。</p>\n<pre><code>/Users/user/opt/anaconda3/envs/ML/lib/python3.6/site-packages/sklearn/utils/deprecation.py:86: FutureWarning: Function make_blobs is deprecated; Please import make_blobs directly from scikit-learn\nwarnings.warn(msg, category=FutureWarning)</code></pre>\n<p>なんだかWarningで怒られましたorz</p>\n<p>将来的にsklearn.datasets.makeblobs()と被るよってことを言いたいらしいです。<em>scikit-learnから直接make_blobsをインポートしろ</em>とか言ってますね。\n次からWarningを避けて行きます。</p>\n<h2>make_blobsに乗り換える</h2>\n<p>make_blobsメソッドに乗り換えて行きます。これはscikit-learnのdatasetsモジュールに含まれているみたいなので、こいつをインポートして行きます。</p>\n<pre><code><span>from</span> sklearn.datasets <span>import</span> make_blobs    <span># これでインポート完了</span></code></pre>\n<p>インポートがうまくいったら次はメソッドを呼び出します。</p>\n<pre><code>X, y = make_blobs()</code></pre>\n<p>これでデータがうまく生成されたようです。無事Warningも出てきません!!!\n念のため、Xの型をみて行きます。</p>\n<pre><code><span>print</span>(<span>\"X.shape: {}\"</span>.<span>format</span>(X.shape))\n\n<span># -> X.shape: (100, 2)</span></code></pre>\n<p>詰まるところ、2つの特徴量を持つデータが100個生成されました。100*2の行列ですね。\nmake_forge()のときは2つの特徴量のデータが26個を期待していたようなので、データ量が増えたみたいですね。</p>\n<h2>まとめ</h2>\n<p>mglearn.datasets.make_forge()でWarningを回避する方法のまとめがこちらです。</p>\n<pre><code><span>from</span> sklearn.datasets <span>import</span> make_blobs    <span># インポート</span>\nX, y = make_blobs()    <span># make_blobsメソッドの実行</span>\n\n<span>\"\"\"\n確認のおまけ\n\"\"\"</span>\n<span>print</span>(<span>\"X.shape: {}\"</span>.<span>format</span>(X.shape))\n\n<span>#-> X.shape: (100, 2)    # 特徴量を2つ持つ100個のデータ</span></code></pre>\n<p>scikit-learn周りは、アップデートが早いので少し古い技術書なだけでも、Future Warningが出たり、Errorが出たりすることが多々あります。\n気をつけながら学習をする必要がありそうですね。では、今回はここまで！</p>\n","Title":"scikit-learnのmake_blobsに乗り換えよう!!","Date":"2020-07-21","Category":"Python","Tags":["ML","Python","Scikit-learn"],"Authors":"ゆうぼう","Slug":"prefer-to-make_blobs","Thumbnail":"/images/thumbnails/python.jpg","Description":"Pythonではじめる機械学習をやっている最中に、mglearnというライブラリからmake_forge()メソッドでデータを生成することがあったのですが、Warningが出て怒られたので、推奨される形に戻すために互換性のあるコードに直します。","Published":true},{"contentHtml":"<p>MySQLのデータベースを扱う際に、Pythonスクリプトから接続したくなったので、Pythonからの接続方法を紹介します。</p>\n<h2>mysql-connector-pythonのインストール</h2>\n<p>まずは、mysql-connector-pythonのインストールを行っていきます。(復習がてら)</p>\n<p>今回は、pipを使ってインストールしていきます。</p>\n<pre><code>$~ pip install mysql-connector-python</code></pre>\n<p>これでエラーが出ずに進めばインストールできているはずです。とりあえずこれで準備は完了。</p>\n<h2>まずはconnectorをインポート</h2>\n<p>まずは接続するためのメソッドをインポートしないと使えないので、インポートしましょう。</p>\n<pre><code><span>import</span> mysql.connector</code></pre>\n<p>これで準備はOK!!</p>\n<h2>接続とDB操作のためのカーソルを生成、そして切断</h2>\n<p>今回の例では、以下の情報を前提にした上で、exampleというデータベースに直で接続していきます。</p>\n<table>\n<thead>\n<tr>\n<th>user</th>\n<th>host</th>\n<th>password</th>\n<th>database</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>root</td>\n<td>127.0.0.1</td>\n<td>example</td>\n<td>example</td>\n</tr>\n</tbody>\n</table>\n<p>さて、早速接続の処理を書いてみましょう。</p>\n<pre><code>cnx = mysql.connector.connect(\n    user=<span>'root'</span>,\n    password=<span>'example'</span>,\n    database=<span>'example'</span>,\n)</code></pre>\n<p>これだけで接続は完了です。（パスワード等が全て正しければ）<br>\nホストはデフォルトが127.0.0.1なので書かなくていいです。</p>\n<p>この後に、カーソルをあてます。</p>\n<pre><code>cur = cnx.cursor()</code></pre>\n<p>この処理だけでオッケーです。</p>\n<p>他の処理等も終わったら、しっかり切断しておきましょう。</p>\n<pre><code>cur.close()\ncnx.close()</code></pre>\n<p>これで接続と切断の処理は完了です。</p>\n<h2>SHOW TABLE表示していく</h2>\n<p>それでは、ここまでで準備は整ったので、*cur = cnx.cursor()*のすぐ後に以下の処理を書いてみましょう。</p>\n<pre><code>sql = <span>\"SHOW TABLES\"</span>    <span>#命令文</span>\n<span>print</span>(cur.execute(sql))    <span>#結果の出力</span>\n\n<span># --> None    #あれ？？ない</span></code></pre>\n<p>見事失敗ですね(笑)</p>\n<p>僕はずっと、実行した結果が戻り値として吐き出されていると思ってこの処理を書きました。しかし、それがないので<em>None</em>が返ってきてしまうのですね...</p>\n<p>それでは正しいスクリプトを書いていきましょう。</p>\n<pre><code>sql = <span>\"SHOW TABLES\"</span>    <span>#命令文</span>\ncur.execute(sql)    <span>#実行</span>\n<span>print</span>(cur.fetchone())    <span>#1つだけフェッチする</span>\n\n<span># --> (example, )</span></code></pre>\n<p>出力本体は人の環境によって異なりますが、このような感じでタプル型でテーブル名が出力されます。</p>\n<p>複数処理結果をまとめて吐き出すには「<strong>fetchall()</strong>」というものがあるようです。今回は一つだけテーブルに対して情報を吐いてもらうので「<strong>fetchone()</strong>」で取得しました。</p>\n<h2>せっかくなので'SHOW DATABASES'もやってみる</h2>\n<p>せっかくなので「<strong>SHOW DATABASES</strong>」も出力してみましょう。DATABASE群をみるので、今回接続する際は先ほどのdatabase引数はなくします。</p>\n<table>\n<thead>\n<tr>\n<th>user</th>\n<th>host</th>\n<th>password</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>root</td>\n<td>127.0.0.1</td>\n<td>example</td>\n</tr>\n</tbody>\n</table>\n<pre><code><span>import</span> mysql.connector\n\ncnx = mysql.connector.connect(\n    user=<span>'root'</span>,\n    password=<span>'example'</span>,\n    )\n\ncur = cnx.cursor()\n\ncur.execute(<span>\"SHOW DATABASES\"</span>)\n<span>print</span>(cur.fetchall())    <span>#&#x3C;&#x3C; fetchall()に注意</span>\n\ncur.close()\ncnx.close()\n\n<span># --> [(example, ), (sys, )]</span></code></pre>\n<p>今回は複数のデータがあることに留意したとして、**fetchall()**しました。ここも見落としポイントが多い気がします。</p>\n<p>僕はそうだったのですが、タプル型に全ての名前が入ると期待したのですが、実際は一つ一つの名前に対してタプルを作り、そのタプル群をリストに入れるようです。</p>\n<h2>まとめ</h2>\n<p>ここまでみてきた結果、一番安全なのはこれでしょうか。</p>\n<pre><code>cur = cnx.cursor()\n\ncur.execute(<span>\"SHOW DATABASES\"</span>)\n<span>print</span>(cur.fetchall()) </code></pre>\n<p>まずはカーソルを当ててから、そこでコマンドを実行する。そのあとは「<strong>fetchall()</strong>」でリストに包める。</p>\n<p>情報が1つしかないことがわかっているならば問題ないのですが、基本的には複数あるという想定のもと、fetchall()で取得する方がいい気もしました。</p>\n","Title":"mysql-connector-pythonで'SHOW ~~~'に困ったのでその対処法","Date":"2020-07-14","Category":"Python","Tags":["MySQL","Python"],"Authors":"ゆうぼう","Slug":"show_tables-mysql-python","Thumbnail":"/images/thumbnails/database.jpg","Description":"Pythonのライブラリ「mysql-connector-python」を使っていたのですが、なかなか'SHOW TABLES'や'SHOW DATABASES'を出力できなかったので、その対処法を備忘録としてまとめます。","Published":true},{"contentHtml":"<p>MySQLのデータベースを扱う際に、Pythonスクリプトから接続したくなったので、Pythonからの接続方法を紹介します。</p>\n<h2>mysql-connector-pythonのインストール</h2>\n<p>まずは、mysql-connector-pythonのインストールを行っていきます。</p>\n<p>今回は、pipを使ってインストールしていきます。</p>\n<pre><code>$~ pip install mysql-connector-python</code></pre>\n<p>これでエラーが出ずに進めばインストールできているはずです。とりあえずこれで準備は完了。</p>\n<h2>まずはconnectorをインポート</h2>\n<p>まずは接続するためのメソッドをインポートしないと使えないので、インポートしましょう。</p>\n<pre><code><span>import</span> mysql.connector</code></pre>\n<p>これで準備はOK!!</p>\n<h2>接続と切断</h2>\n<p>それではここまで完成できていれば、あとは接続の処理を書くだけです。</p>\n<p>今回の例では、以下の情報を前提にしてみます。</p>\n<table>\n<thead>\n<tr>\n<th>user</th>\n<th>host</th>\n<th>password</th>\n<th>database</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>root</td>\n<td>127.0.0.1</td>\n<td>**********</td>\n<td>example</td>\n</tr>\n</tbody>\n</table>\n<p>さて、早速接続の処理を書いてみましょう。</p>\n<pre><code><span>import</span> mysql.connectorcnx = mysql.connecor.connect(\n        user=<span>'root'</span>,\n        host=<span>'127.0.0.1'</span>,\n        password=<span>'**********'</span>,\n        database=<span>'example'</span>,\n    )</code></pre>\n<p>これだけで接続は完了です。（パスワード等が全て正しければ）</p>\n<p>他の処理等も終わったら、しっかり切断しておきましょう。</p>\n<pre><code>    cnx.close()</code></pre>\n<p>これで接続と切断の処理は完了です。</p>\n<p>また、hostが127.0.0.1であることは、他のポートとぶつかっているために人為的にローカルホストやポート番号を変えていなければ、デフォルトの位置になっているはずなので、以下でも実行可能です。</p>\n<pre><code><span>import</span> mysql.connectorcnx = mysql.connecor.connect(\n        user=<span>'root'</span>,\n        host=<span>'127.0.0.1'</span>,\n        password=<span>'**********'</span>,\n        database=<span>'example'</span>,\n    cnx = mysql.connecor.connect(\n        user=<span>'root'</span>,\n        password=<span>'**********'</span>,\n        database=<span>'example'</span>,\n    )</code></pre>\n<h2>connectの引数の内容を辞書にまとめておく</h2>\n<p>先ほど、引数に入力した情報を辞書にまとめて接続することもできます。\n以下のようなスクリプトになります。</p>\n<pre><code><span>import</span> mysql.connector\n\n    config = {\n        user: <span>'root'</span>,\n        host: <span>'127.0.0.1'</span>,\n        password: <span>'**********'</span>,\n        database: <span>'example'</span>,\n    }\n    cnx = mysql.connector.connect(**config)\n\n    cnx.close()</code></pre>\n<p>configは辞書型なので、「**」でアンパックすることも忘れないようにしましょう。</p>\n<h2>まとめ</h2>\n<p>最終的にまとめると、流れはこんな感じです。</p>\n<h2>#辞書使わない</h2>\n<pre><code><span>import</span> mysql.connector\n\ncnx = mysql.connecor.connect(\n    user=&#x3C;span <span><span>class</span>=\"<span>strings</span>\">'<span>root</span>',\n    <span>host</span>=&#x3C;<span>span</span> <span>class</span>=\"<span>strings</span>\">'127.0.0.1',\n    <span>password</span>=&#x3C;<span>span</span> <span>class</span>=\"<span>strings</span>\">'**********',\n    <span>database</span>=&#x3C;<span>span</span> <span>class</span>=\"<span>strings</span>\">'<span>example</span>',\n)\n\n<span>cnx</span>.<span>close</span>()</span></code></pre>\n<h2>#辞書型</h2>\n<pre><code><span>import</span> mysql.connector\n\nconfig = {\n    user: &#x3C;span <span><span>class</span>=\"<span>strings</span>\">'<span>root</span>',\n    <span>host</span>:</span> &#x3C;span <span><span>class</span>=\"<span>strings</span>\">'127.0.0.1',\n    <span>password</span>:</span> &#x3C;span <span><span>class</span>=\"<span>strings</span>\">'**********',\n    <span>database</span>:</span> &#x3C;span <span><span>class</span>=\"<span>strings</span>\">'<span>example</span>',\n}\n<span>cnx</span> = <span>mysql</span>.<span>connector</span>.<span>connect</span>(<span>**config</span>)\n\n<span>cnx</span>.<span>close</span>()</span></code></pre>\n<p>後ほど、テーブルを実際に作ったり、インサートしたりの方法を紹介しようと思います。</p>\n","Title":"mysql-connector-pythonでローカルDBに接続する","Date":"2020-07-13","Category":"Python","Tags":["MySQL","Python"],"Authors":"ゆうぼう","Slug":"connect-to-mysql-python","Thumbnail":"/images/thumbnails/database.jpg","Description":"Pythonのライブラリ「mysql-connector-python」を使って、ローカルのMySQLデータベースに接続します。","Published":true}],"category":"Python","categories":["Web","JavaScript","Competition","Cloud","Linux","Python","ML","Go","SQL"],"tags":["Apache","Appium","atmaCup","AWS","CentOS7","CentOS8","Colab","conda","CSS","ffmpeg","Flask","Go","Google Colaboratory","Heroku","HTML","JavaScript","JSON","Kaggle","Linux","Mac","make","map","MeCab","ML","MySQL","NLP","node.js","Pandas","Python","Pytorch","pytorch-lightning","Scikit-learn","Selenium","SISR","subprocess","Super-Resolution","tensorflow","Tkinter","zsh","オブジェクト指向","デコレータ","データ分析","特殊メソッド","超解像"],"page":2},"__N_SSG":true}